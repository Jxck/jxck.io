<!DOCTYPE html>
<html lang=ja>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width,initial-scale=1">

  <link rel=author    href=https://jxck.io/humans.txt>
  <link rel=manifest  href=/manifest.webmanifest>
  <link rel=alternate href=/feeds/atom.xml type=application/atom+xml title=blog.jxck.io>
  <link rel=canonical href=https://blog.jxck.io/entries/2021-05-28/blog-over-sxg.html>

  <link rel=preload as=script href=https://www.jxck.io/assets/js/prism.js?250306_012045>
  <link rel=preload as=script href=https://www.jxck.io/assets/js/main.js?250125_005305>

  <script defer src=https://www.jxck.io/assets/js/prism.js?250306_012045></script>
  <script defer src=https://www.jxck.io/assets/js/main.js?250125_005305></script>

  <link rel=icon type=image/svg+xml sizes=any href=https://blog.jxck.io/assets/img/jxck.svg>
  <link rel=icon type=image/png sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.png>
  <link rel=icon type=image/png sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.png>
  <link rel=icon type=image/png sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.png>
  <link rel=icon type=image/png sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.png>
  <link rel=icon type=image/png sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.png>

  <link rel=icon type=image/webp sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.webp>
  <link rel=icon type=image/webp sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.webp>
  <link rel=icon type=image/webp sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.webp>
  <link rel=icon type=image/webp sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.webp>
  <link rel=icon type=image/webp sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.webp>

  <link rel=apple-touch-icon type=image/png sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.png>
  <link rel=apple-touch-icon type=image/png sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.png>
  <link rel=apple-touch-icon type=image/png sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.png>
  <link rel=apple-touch-icon type=image/png sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.png>
  <link rel=apple-touch-icon type=image/png sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.png>

  <link rel=apple-touch-icon type=image/webp sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.webp>
  <link rel=apple-touch-icon type=image/webp sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.webp>
  <link rel=apple-touch-icon type=image/webp sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.webp>
  <link rel=apple-touch-icon type=image/webp sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.webp>
  <link rel=apple-touch-icon type=image/webp sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.webp>

  <meta name=author              content=Jxck>
  <meta name=description         content="本サイトを (Non AMP) SXG に対応した。これにより、Google のモバイル検索では、結果を表示した時点でこのサイトの SXG が Prefetch され、結果を選択したら Cache から素早く表示されつつ、アドレスバーにも本サイトのものとして表示される。この...">
  <meta name=keywords            content="prefetch,amp,signed-http-exchange,webpackaging">
  <meta name=theme-color         content=#000000>

  <meta property=og:type         content=article>
  <meta property=og:url          content=https://blog.jxck.io/entries/2021-05-28/blog-over-sxg.html>
  <meta property=og:title        content="Non AMP SXG による Prefetch 対応と AMP 提供の停止 | blog.jxck.io">
  <meta property=og:site_name    content=blog.jxck.io>
  <meta property=og:description  content="本サイトを (Non AMP) SXG に対応した。これにより、Google のモバイル検索では、結果を表示した時点でこのサイトの SXG が Prefetch され、結果を選択したら Cache から素早く表示されつつ、アドレスバーにも本サイトのものとして表示される。この...">
  <meta property=og:image        content=https://blog.jxck.io/assets/img/jxck.600x600.png>

  <meta name="Hatena::Bookmark" content="nocomment">
  <link rel="author" href="http://www.hatena.ne.jp/Jxck/" />


  <script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://blog.jxck.io"
    },
    "headline": "Non AMP SXG による Prefetch 対応と AMP 提供の停止 | blog.jxck.io",
    "image": [
      "https://www.jxck.io/assets/img/jxck.png",
      "https://logo.jxck.io/jxck.1200x1200.png"
    ],
    "datePublished": "2021-05-28T08:00:00+08:00",
    "dateModified": "2025-01-23T08:00:00+08:00",
    "author": {
      "@type": "Person",
      "name": "Jxck",
      "image": "https://blog.jxck.io/assets/img/jxck.png"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Jxck",
      "logo": {
        "@type": "ImageObject",
        "url": "https://logo.jxck.io/jxck.120x120.png",
        "height": 120,
        "width": 120
      }
    },
    "description": "本サイトを (Non AMP) SXG に対応した。これにより、Google のモバイル検索では、結果を表示した時点でこのサイトの SXG が Prefetch され、結果を選択したら Cache から素早く表示されつつ、アドレスバーにも本サイトのものとして表示される。この..."
  }
  </script>

  <title>Non AMP SXG による Prefetch 対応と AMP 提供の停止 | blog.jxck.io</title>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/body.css?250126_044049>
</head>
<body>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/header.css?250125_021259>
  <header>
    <nav>
      <ul>
        <li><a href=https://blog.jxck.io      ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/blog.svg?160301_215351   title=blog   alt="blog logo" class=logo></a>
        <li><a href=/search                   ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/search.svg?190421_130410 title=search alt=search></a>
        <li><a href=.                         ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/up.svg?160831_002319     title=up     alt="move to parent directory"></a>
        <li><a href=/feeds/atom.xml           ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/rss.svg?160227_124312    title=rss    alt="rss feed"></a>
        <li><a href=https://jxck.io/humans.txt><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/humans.svg?160831_002319 title=humans alt=huamns.txt></a>
        <li><a href=https://jxck.io           ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/jxck.svg?190123_200004   title=jxck   alt="jxck logo" class=logo></a>
      </ul>
    </nav>
  </header>

  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/markdown.css?250125_021828>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/main.css?250125_022022>
  <main>
    <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/info.css?250125_014450>
    <dl class=info>
      <div><dt>created_at</dt><dd><time class=created_at datetime=2021-05-28>2021-05-28</time></dd></div>
      <div><dt>updated_at</dt><dd><time class=updated_at datetime=2025-01-23>2025-01-23</time></dd></div>
      <div>
        <dt>tags</dt>
        <dd>
          <nav class=tags>
            <ul>
              <li><a href="/tags#prefetch">prefetch</a>
              <li><a href="/tags#amp">amp</a>
              <li><a href="/tags#signed-http-exchange">signed-http-exchange</a>
              <li><a href="/tags#webpackaging">webpackaging</a>
            </ul>
          </nav>
        </dd>
      </div>
      <div>
        <dt>toc</dt>
        <dd>
          <button popovertarget="toc">open</button>
          <nav id=toc popover=manual>
            <h2>ToC</h2>
            <button popovertarget="toc" popovertargetaction="hide">❌</button>
            <ol>
              <li><a href="#intro">Intro</a>
              <li><a href="#non-amp-sxg">(Non AMP) SXG</a>
              <li><a href="#sxg-の配信">SXG の配信</a>
              <li><a href="#web-packager-server">Web Packager Server</a>
              <ol>
                <li><a href="#webpkgserver">webpkgserver</a>
                <li><a href="#webpkgserver.toml">webpkgserver.toml</a>
              </ol>
              <li><a href="#routing">Routing</a>
              <li><a href="#content-negotiation">Content Negotiation</a>
              <ol>
                <li><a href="#webpkg"><code translate=no>/webpkg</code></a>
              </ol>
              <li><a href="#動作検証">動作検証</a>
              <ol>
                <li><a href="#debug">Debug</a>
                <li><a href="#google-bot">Google Bot</a>
                <li><a href="#amp-sxg-と-non-amp-sxg">AMP SXG と Non AMP SXG</a>
                <li><a href="#amp-の停止">AMP の停止</a>
                <li><a href="#search-result">Search Result</a>
              </ol>
              <li><a href="#outro">Outro</a>
              <li><a href="#resources">Resources</a>
            </ol>
          </nav>
        </dd>
      </div>
    </dl>

    <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/article.css?250125_013946>
    <article>
      <h1><a href="">Non AMP SXG による Prefetch 対応と AMP 提供の停止</a></h1>
      <section>
        <h2 id="intro"><a href="#intro">Intro</a></h2>
        <p>本サイトを (Non AMP) SXG に対応した。
        <p>これにより、Google のモバイル検索では、結果を表示した時点でこのサイトの SXG が Prefetch され、結果を選択したら Cache から素早く表示されつつ、アドレスバーにも本サイトのものとして表示される。
        <p>この、Non AMP SXG 対応にあたって、本サイトの AMP の提供も停止することになった。
        <p>移行の作業ログと、関連する流れについて記す。
      </section>
      <section>
        <h2 id="non-amp-sxg"><a href="#non-amp-sxg">(Non AMP) SXG</a></h2>
        <p>SXG については過去に解説した。
        <ul>
          <li><a href="https://blog.jxck.io/entries/2018-12-01/signed-http-exchanges.html">WebPackaging の Signed HTTP Exchanges</a>
        </ul>
        <p>本サイトでは AMP SXG に対応しており、Google Search からの AMP ページへの遷移には SXG が取得され、本サイトのドメインが表示される。
        <ul>
          <li><a href="https://blog.jxck.io/entries/2020-12-25/amp-signed-http-exchange.html">AMP SXG 対応</a>
        </ul>
        <p>今年の 4 月に、AMP だけでなく通常のコンテンツであっても SXG を配信すれば Google Bot がそれを取得し、Google Search のモバイル検索結果で Prefetch が行われるようになった。
        <p>これにより、モバイル検索結果を表示した時点で SXG がブラウザに読み込まれ、結果をクリックしたら、リクエストを投げる代わりにキャッシュから HTML を表示するだけで済むため、検索流入のユーザに対して、初期表示のパフォーマンス向上が期待される。
        <p>Google はこれを AMP SXG と対比して <a href="https://developers.google.com/search/docs/advanced/experience/signed-exchange#:~:text=non-,amp,-results" target=_blank>Non AMP SXG</a> と称しており、本サイトでもその使い分けを採用するが、実態はまさしく SXG そのものだ。
      </section>
      <section>
        <h2 id="sxg-の配信"><a href="#sxg-の配信">SXG の配信</a></h2>
        <p>SXG の配信は、コンテンツを SXG に変換するだけではなく、Content Negotiation の対応や Validity URL の提供など、いくつか対応が必要となる。
        <p>また、SXG はファイル自体に期限があるため、<a href="https://github.com/WICG/webpackage/tree/main/go/signedexchange/cmd/gen-signedexchange" target=_blank>gen-signedexchange</a> といったツールで静的に作る場合は更新が必要となる。
        <p>今回はこうした処理を全て肩代わりしてくれる Web Packager Server を用いることにした。
        <ul>
          <li><a href="https://github.com/google/webpackager/tree/master/cmd/webpkgserver" target=_blank>Web Packager Server - google/webpackager</a>
        </ul>
      </section>
      <section>
        <h2 id="web-packager-server"><a href="#web-packager-server">Web Packager Server</a></h2>
        <p>Web Packager Server は Web Packager に含まれる webpkgserver コマンドを用いる。
        <p>このコマンドはサーバを起動し、リクエストに応じて SXG を生成して返すため、フロントサーバから Proxy するように構成する。
        <section>
          <h3 id="webpkgserver"><a href="#webpkgserver">webpkgserver</a></h3>
          <p>webpkgserver は <code translate=no>go get</code> ではうまく動かなかったため、README にある通りソースからビルドした。
          <link rel=stylesheet property=stylesheet type=text/css href="https://www.jxck.io/assets/css/pre.css?250125_015123">
          <pre class=shell data-code=shell><code translate=no class=language-shell>git clone --depth 1 https://github.com/google/webpackager
cd webpackager/cmd/webpkgserver
go build .</code></pre>
          <p>これで <code translate=no>webpkgserver</code> コマンドが生成される。
          <p>実行には設定ファイルの toml を引数に渡す。
          <pre class=shell-session data-code=shell-session><code translate=no class=language-shell-session>$ webpkgserver --config webpkgserver.toml</code></pre>
        </section>
        <section>
          <h3 id="webpkgserver.toml"><a href="#webpkgserver.toml">webpkgserver.toml</a></h3>
          <p>設定ファイルは、同梱されている <a href="https://github.com/google/webpackager/blob/master/cmd/webpkgserver/webpkgserver.example.toml" target=_blank>webpkgserver.example.toml</a> を修正する。
          <p>ほとんどデフォルトが使えるため、Port と SXG 用の証明書、Domain あたりを気をつければ良いだろう。
          <pre class=yaml data-code=yaml><code translate=no class=language-yaml>[Listen]
  Port = 11000

[Server]
  DocPath = &apos;/priv/doc&apos;

[SXG.Cert]
  PEMFile = &apos;/keys/sxg/blog_jxck_io_full.crt&apos;
  KeyFile = &apos;/keys/sxg/blog_jxck_io.key&apos;
  CacheDir = &apos;/tmp/webpkg&apos;

[SXG.ACME]
  Enable = false

[[Sign]]
  Domain = &apos;blog.jxck.io&apos;</code></pre>
          <p>これを引数にするだけでサーバは起動する。
          <p>ローカルで起動した時点で、動作の確認は以下のように行うことができる。
          <pre class=shell data-code=shell><code translate=no class=language-shell>export URL=&quot;https://blog.jxck.io/&quot;
curl -s --output - -H &apos;accept: application/signed-exchange;v=b3,*/*;q=0.1&apos; http://127.0.0.1:11000/priv/doc/$URL &gt; dump.sxg
dump-signedexchange -i dump.sxg</code></pre>
        </section>
      </section>
      <section>
        <h2 id="routing"><a href="#routing">Routing</a></h2>
        <p>このサービスに対して行うべきルーティングは 3 つだ。
        <ul>
          <li>webpkgserver に直接アクセスできないようポートを閉じる
          <li><code translate=no>/webpkg</code> を webpkgserver に転送
          <li>Content Negotiation で SXG を返す場合は <code translate=no>/priv/doc</code> をつけて proxy
          <li>それ以外は proxy しない
        </ul>
      </section>
      <section>
        <h2 id="content-negotiation"><a href="#content-negotiation">Content Negotiation</a></h2>
        <p>基本的にはリクエストヘッダに <code translate=no>Accept: application/signed-exchange;v=b3</code> が付与されている場合、Web Package Server に転送すれば良い。
        <p>しかし、Google の Bot だけでなく、Chrome も現状このヘッダをデフォルトで付与しているため、単にこのヘッダの有無だけを見てルーティングすると、ブラウザからのリクエストにも SXG を返すことになる。
        <p>これについては Q value を参照するように <a href="https://github.com/google/webpackager/blob/master/cmd/webpkgserver/README.md#content-negotiation" target=_blank>ドキュメント</a> に書かれている。
        <p>具体的には Chrome と Google Bot の付与する Accept は以下のように異なる。
        <pre class=http data-code=http><code translate=no class=language-http># Google Bot
Accept: text/html,application/xhtml+xml,application/signed-exchange;v=b3,application/xml;q=0.9,*/*;q=0.8

# Chrome 90
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</code></pre>
        <p>SXG に注目すると Chrome は Q value を HTML などよりも下げているが、Google Bot は Q value を下げずに HTML と同等にしていることがわかる。
        <p>ドキュメントでは、Google Bot は Q value を付与しないことで優先度を下げないため、Q value の有無が判断材料になると書かれており、それを Nginx で実現する正規表現の例が書かれている。
        <p>しかしドキュメントの正規表現が気に入らず、また本サイトでは h2o の mruby handler で対応するため、以下のように否定先読みで実現することとした。
        <pre class=ruby data-code=ruby><code translate=no class=language-ruby>if /application\/signed-exchange;v=b3(?!;q=)/.match(env[&quot;HTTP_ACCEPT&quot;])
  # reproxy to backend webpkgserver
  next [307, {&quot;x-reproxy-url&quot; =&gt; &quot;http://127.0.0.1:11000/priv/doc/https://blog.jxck.io#{path}&quot;}, []]
else
  # fallthrough
  next [399, {}, []]
end</code></pre>
        <p>ここまでが成功しているかは、以下のようにテストをすることができる。
        <pre class=shell data-code=shell><code translate=no class=language-shell>export URL=&quot;https://blog.jxck.io/&quot;
curl -s --output - -H &apos;accept: application/signed-exchange;v=b3,*/*;q=0.1&apos; $URL &gt; dump.sxg
dump-signedexchange -i dump.sxg -signature</code></pre>
        <section>
          <h3 id="webpkg"><a href="#webpkg"><code translate=no>/webpkg</code></a></h3>
          <p>webpkgserver は SXG に必要な Certificate URL を自動で提供してくれる。
          <p>そのパスは <code translate=no>/webpkg/cert/#{base64}</code> となっているため、ここへのリクエストはそのまま転送すれば良い。
          <pre class=h2o data-code=h2o><code translate=no class=language-h2o>&quot;/webpkg&quot;:
  proxy.reverse.url: &quot;http://127.0.0.1:11000/webpkg&quot;</code></pre>
          <p>dump した sxg の中に cert url があるためそこから URL を取得すると以下のようにテストできる。
          <pre class=shell data-code=shell><code translate=no class=language-shell># dump certurl
curl -s --output - https://blog.jxck.io/webpkg/cert/g8zY1NBH4DQt9qIWOWBqLWvs6jAnJmURAtNRc2WChDE &gt; cert.cbor
dump-certurl -i cert.cbor</code></pre>
        </section>
      </section>
      <section>
        <h2 id="動作検証"><a href="#動作検証">動作検証</a></h2>
        <section>
          <h3 id="debug"><a href="#debug">Debug</a></h3>
          <p>curl でテストしても良いが、デプロイした後ならば Chrome でアクセスして Devtools で確認すると詳細がデバッグできる。
          <p>しかし、今回の設定では Chrome のデフォルトの Q value がついた <code translate=no>Accept</code> ヘッダでは SXG が取得できないため、<a href="https://chrome.google.com/webstore/detail/modheader/idgpnmonknjnojddfkpgkljpfnnfcklj" target=_blank>ModHeader</a> などを用いて Q value を無くすよう上書きする必要がある。
          <p>その状態でアクセスし、成功すれば以下のように SXG が確認できる。
          <p>まず、Network の Timeline 上は SXG のレスポンスと CBOR リクエストが続き、SXG から取り出された HTML が取得されている。
          <p>
            <picture>
              <source type=image/avif srcset=sxg-timeline.avif?231116_154951>
              <source type=image/webp srcset=sxg-timeline.webp?240402_005258>
              <img loading=lazy decoding=async src=sxg-timeline.png?230731_162900 alt="SXG レスポンス、 CBOR レスポンス、 SXG から取り出された HTML の順に取得されている Devtools Timeline の図" width=2390 height=300>
            </picture>
          </p>
          <p>SXG の Preview タブを見ると、Signature や Certificate も正しく解釈されていることが確認できる。
          <p>
            <picture>
              <source type=image/avif srcset=sxg-response.avif?231116_154951>
              <source type=image/webp srcset=sxg-response.webp?240402_005258>
              <img loading=lazy decoding=async src=sxg-response.png?230731_162900 alt="SXG の Signature や Certificate が正しく解釈されている Devtools の Preview の図" width=2128 height=1192>
            </picture>
          </p>
        </section>
        <section>
          <h3 id="google-bot"><a href="#google-bot">Google Bot</a></h3>
          <p>この状態で放置しておくと GoogleBot がクロールしに来た際に、SXG の Content Negotiation に成功して SXG をクロールしていく。
          <p>SXG が Google の Cache に乗ったかは、以下のような規則で生成したキャッシュ URL に直接アクセスすれば確認できる。
          <ul>
            <li>(before): <a href="https://blog.jxck.io/entries/2016-07-12/cache-control-immutable.html">https://blog.jxck.io/entries/2016-07-12/cache-control-immutable.html</a>
            <li>( after): <a href="https://blog-jxck-io.webpkgcache.com/doc/-/s/blog.jxck.io/entries/2016-07-12/cache-control-immutable.html" target=_blank>https://blog-jxck-io.webpkgcache.com/doc/-/s/blog.jxck.io/entries/2016-07-12/cache-control-immutable.html</a>
          </ul>
        </section>
        <section>
          <h3 id="amp-sxg-と-non-amp-sxg"><a href="#amp-sxg-と-non-amp-sxg">AMP SXG と Non AMP SXG</a></h3>
          <p>本来はこれで Google Search Result に反映されて、Prefetch が埋め込まれるはずだった。
          <p>しかし、本サイトは既に <a href="https://blog.jxck.io/entries/2016-02-01/amp-html.html">AMP</a> と <a href="https://blog.jxck.io/entries/2020-12-25/amp-signed-http-exchange.html">AMP SXG</a> に対応しているため、モバイルの検索結果では AMP がヒットし、AMP SXG がリンクされている。
          <p>
            <picture>
              <source type=image/avif srcset=gsrp-amp.avif?240313_215035>
              <source type=image/webp srcset=gsrp-amp.webp?240313_215035>
              <img loading=lazy decoding=async src=gsrp-amp.jpeg?240313_215035 alt="AMP SXG と Non AMP SXG を両方デプロイした場合、 Google Search Result では AMP が優先される" width=2322 height=684>
            </picture>
          </p>
          <p>どうやら Non AMP SXG がクロールされても、同時に AMP および AMP SXG に対応している場合は、現状 AMP 側が優先されるようだ。
          <p>おそらく両方に対応しているサイト自体が他に無いため、ここをコントロールする情報は無く、今後 Non AMP SXG の方が優先されたりする可能性も無くはないが、まったく未定な状態となりいつまでたっても動作検証ができない。
          <p>CWV や SXG 、さらにこれから展開される予定の Prerender2 などを見据えれば、AMP 自体は特別扱いされなくなっていくと理解しているため、そもそも AMP はどこかでやめるつもりでいた。
          <p>Bento AMP が気にるので、念のためにコンテンツは残すが、これを機に AMP の提供を停止することにした。
        </section>
        <section>
          <h3 id="amp-の停止"><a href="#amp-の停止">AMP の停止</a></h3>
          <p>AMP をやめる方法は基本は以下だ。
          <ul>
            <li>canonical html から <code translate=no>&lt;link rel=amphtml&gt;</code> を削除
            <li>amp html へのリクエストは canonical html にリダイレクト
          </ul>
          <p>デプロイ上はこれだけで、後はクローラが来ればしばらくして消えるかと思ったが、なかなか検索結果からは消えなかった。
          <p>試しに 1 つ Search Console から AMP URL を削除するようにリクエストしたが、それでもなかなか反映されなかった。
          <p>結果、以下にある削除リクエストを実施した。
          <ul>
            <li><a href="https://developers.google.com/amp/cache/update-cache" target=_blank>Update AMP Content</a>
          </ul>
          <p>一晩放置したところ、検索結果から AMP が消え始めた。
        </section>
        <section>
          <h3 id="search-result"><a href="#search-result">Search Result</a></h3>
          <p>検索結果から AMP が消え、モバイルでも通常の HTML が表示されるようになった。
          <p>また、ページの DOM 中に <code translate=no>&lt;link rel=prefetch&gt;</code> が挿入されていることが確認できる。
          <p>
            <picture>
              <source type=image/avif srcset=gsrp-sxg.avif?240313_215035>
              <source type=image/webp srcset=gsrp-sxg.webp?240313_215035>
              <img loading=lazy decoding=async src=gsrp-sxg.jpeg?240313_215035 alt="Non AMP SXG が Prefetch されている" width=2406 height=774>
            </picture>
          </p>
          <p>これにより、検索結果を表示した時点で HTML は Google の SXG Cache から取得されている。
          <p>
            <picture>
              <source type=image/avif srcset=sxg-prefetch.avif?231116_154951>
              <source type=image/webp srcset=sxg-prefetch.webp?240402_005258>
              <img loading=lazy decoding=async src=sxg-prefetch.png?230731_162900 alt="検索結果を表示した時点で HTML は Google の SXG Cache から取得されている" width=3030 height=742>
            </picture>
          </p>
          <p>実際に検索結果に遷移すると、HTTP Request は筆者のサーバには発生せず、Prefetch された HTML から展開されていることがわかる。
          <p>
            <picture>
              <source type=image/avif srcset=sxg-navigate.avif?231116_154951>
              <source type=image/webp srcset=sxg-navigate.webp?240402_005258>
              <img loading=lazy decoding=async src=sxg-navigate.png?230731_162900 alt="検索結果に遷移すると Prefetch した HTML が展開されている" width=3044 height=736>
            </picture>
          </p>
          <p>このとき(スクショでは切れているが)、アドレスバーには SXG Cache の URL である <code translate=no>https://blog-jxck-io.webpkgcache.com/</code> ではなく、SXG を検証した結果として <code translate=no>https://blog.jxck.io</code> が表示されている。
        </section>
      </section>
      <section>
        <h2 id="outro"><a href="#outro">Outro</a></h2>
        <p>本サイトを Non AMP SXG に対応し、Google のモバイル検索結果で Prefetch されることを確認した。
        <p>本来、そこで発生したパフォーマンスの改善を CWV を指標として測るべきでもあるが、ローカルの Lighthouse はリロードベースでの測定しかできず、本サイトのアクセス数では Field Data が得られないため Page Speed Insight などでの変化も見ることができない。
        <p>各 API で色々工夫すれば測れるかもしれないが、本サイトは Origin が十分に速いため、有意な数値差も期待できず、検証はここまでとした。
        <p>また、今回ここで AMP をやめることは本来意図してなかったが、ここで不要になったように SXG も AMP の遺産の 1 つとも言え、すでに AMP はある程度の役目を終えつつあるだろう。
        <p>それについて書いたところ長くなったので、いずれ別途記事にまとめたいと思う。
      </section>
      <section>
        <h2 id="resources"><a href="#resources">Resources</a></h2>
        <ul>
          <li>Spec
          <li>Explainer
          <li>Requirements Doc
          <li>Mozilla Standard Position
          <li>Webkit Position
          <li>
            TAG Design Review
            <ul>
              <li><a href="https://github.com/w3ctag/design-reviews/issues/235" target=_blank>https://github.com/w3ctag/design-reviews/issues/235</a>
            </ul>
          </li>
          <li>
            Intents
            <ul>
              <li>
                Intent to Ship: Signed HTTP Exchanges (SXG)
                <ul>
                  <li><a href="https://groups.google.com/a/chromium.org/g/blink-dev/c/gPH_BcOBEtc" target=_blank>https://groups.google.com/a/chromium.org/g/blink-dev/c/gPH_BcOBEtc</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            Chrome Platform Status
            <ul>
              <li><a href="https://www.chromestatus.com/feature/5745285984681984" target=_blank>https://www.chromestatus.com/feature/5745285984681984</a>
            </ul>
          </li>
          <li>WPT (Web Platform Test)
          <li>DEMO
          <li>Blog
          <li>Presentation
          <li>Issues
          <li>
            Other
            <ul>
              <li>
                Privacy-preserving instant loading for all web content - The AMP Blog
                <ul>
                  <li><a href="https://blog.amp.dev/2019/05/22/privacy-preserving-instant-loading-for-all-web-content/" target=_blank>https://blog.amp.dev/2019/05/22/privacy-preserving-instant-loading-for-all-web-content/</a>
                </ul>
              </li>
              <li>
                Get started with signed exchanges on Google Search - 検索セントラル
                <ul>
                  <li><a href="https://developers.google.com/search/docs/advanced/experience/signed-exchange?hl=ja#debug-the-google-sxg-cache" target=_blank>https://developers.google.com/search/docs/advanced/experience/signed-exchange?hl=ja#debug-the-google-sxg-cache</a>
                </ul>
              </li>
              <li>
                ページ エクスペリエンスの更新に対応するための期間、ツール、詳細情報 - Google 検索セントラル ブログ
                <ul>
                  <li><a href="https://developers.google.com/search/blog/2021/04/more-details-page-experience?hl=ja" target=_blank>https://developers.google.com/search/blog/2021/04/more-details-page-experience?hl=ja</a>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </section>
    </article>
  </main>
  <hr>

  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/footer.css?250125_012520>
  <footer>
    <p class=copyright><small>Copyright &copy; 2016 <a href=https://jxck.io>Jxck</a>. All Rights Reserved.</small> See <small><a href=https://jxck.io/policies/site.html>Site Policy</a> and <a href=https://jxck.io/policies/privacy.html>Privacy Policy</a>.</small></p>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5a6d3cda77d54761ba2f5c3f56d17ceb"}'></script><!-- End Cloudflare Web Analytics -->
  </footer>

</body>
</html>
