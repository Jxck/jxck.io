<!DOCTYPE html>
<html lang=ja>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width,initial-scale=1">

  <link rel=author    href=https://jxck.io/humans.txt>
  <link rel=manifest  href=/manifest.webmanifest>
  <link rel=alternate href=/feeds/atom.xml type=application/atom+xml title=blog.jxck.io>
  <link rel=canonical href=https://blog.jxck.io/entries/2023-11-05/reload-and-cache.html>

  <link rel=preload as=script href=https://www.jxck.io/assets/js/prism.js?210115_215132>
  <link rel=preload as=script href=https://www.jxck.io/assets/js/main.js?230728_230731>

  <script defer src=https://www.jxck.io/assets/js/prism.js?210115_215132></script>
  <script defer src=https://www.jxck.io/assets/js/main.js?230728_230731></script>

  <link rel=icon type=image/svg+xml sizes=any href=https://blog.jxck.io/assets/img/jxck.svg>
  <link rel=icon type=image/png sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.png>
  <link rel=icon type=image/png sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.png>
  <link rel=icon type=image/png sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.png>
  <link rel=icon type=image/png sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.png>
  <link rel=icon type=image/png sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.png>

  <link rel=icon type=image/webp sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.webp>
  <link rel=icon type=image/webp sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.webp>
  <link rel=icon type=image/webp sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.webp>
  <link rel=icon type=image/webp sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.webp>
  <link rel=icon type=image/webp sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.webp>

  <link rel=apple-touch-icon type=image/png sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.png>
  <link rel=apple-touch-icon type=image/png sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.png>
  <link rel=apple-touch-icon type=image/png sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.png>
  <link rel=apple-touch-icon type=image/png sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.png>
  <link rel=apple-touch-icon type=image/png sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.png>

  <link rel=apple-touch-icon type=image/webp sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.webp>
  <link rel=apple-touch-icon type=image/webp sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.webp>
  <link rel=apple-touch-icon type=image/webp sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.webp>
  <link rel=apple-touch-icon type=image/webp sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.webp>
  <link rel=apple-touch-icon type=image/webp sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.webp>

  <meta name=author              content=Jxck>
  <meta name=description         content="こういうタイトルを付けるのはあまり好きではないが、あえてこのようにした。">
  <meta name=keywords            content="">
  <meta name=theme-color         content=#000000>

  <meta property=og:type         content=article>
  <meta property=og:url          content=https://blog.jxck.io/entries/2023-11-05/reload-and-cache.html>
  <meta property=og:title        content="ブラウザでリロードしながらキャッシュの挙動を確認してる全ての開発者へ | blog.jxck.io">
  <meta property=og:site_name    content=blog.jxck.io>
  <meta property=og:description  content="こういうタイトルを付けるのはあまり好きではないが、あえてこのようにした。">
  <meta property=og:image        content=https://blog.jxck.io/assets/img/jxck.600x600.png>

  <meta name="Hatena::Bookmark" content="nocomment">
  <link rel="author" href="http://www.hatena.ne.jp/Jxck/" />


  <script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://blog.jxck.io"
    },
    "headline": "ブラウザでリロードしながらキャッシュの挙動を確認してる全ての開発者へ | blog.jxck.io",
    "image": [
      "https://www.jxck.io/assets/img/jxck.png",
      "https://logo.jxck.io/jxck.1200x1200.png"
    ],
    "datePublished": "2023-11-05T08:00:00+08:00",
    "dateModified": "2024-11-15T08:00:00+08:00",
    "author": {
      "@type": "Person",
      "name": "Jxck",
      "image": "https://blog.jxck.io/assets/img/jxck.png"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Jxck",
      "logo": {
        "@type": "ImageObject",
        "url": "https://logo.jxck.io/jxck.120x120.png",
        "height": 120,
        "width": 120
      }
    },
    "description": "こういうタイトルを付けるのはあまり好きではないが、あえてこのようにした。"
  }
  </script>

  <title>ブラウザでリロードしながらキャッシュの挙動を確認してる全ての開発者へ | blog.jxck.io</title>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/body.css?240701_012822>
</head>
<body>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/header.css?230926_134917>
  <header>
    <nav>
      <ul>
        <li><a href=https://blog.jxck.io      ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/blog.svg?160301_215351   title=blog   alt="blog logo" class=logo></a>
        <li><a href=/search                   ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/search.svg?190421_130410 title=search alt=search></a>
        <li><a href=.                         ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/up.svg?160831_002319     title=up     alt="move to parent directory"></a>
        <li><a href=/feeds/atom.xml           ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/rss.svg?160227_124312    title=rss    alt="rss feed"></a>
        <li><a href=https://jxck.io/humans.txt><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/humans.svg?160831_002319 title=humans alt=huamns.txt></a>
        <li><a href=https://jxck.io           ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/jxck.svg?190123_200004   title=jxck   alt="jxck logo" class=logo></a>
      </ul>
    </nav>
  </header>

  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/markdown.css?220304_061221>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/main.css?201223_011131>
  <main>
    <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/info.css?240713_033306>
    <dl class=info>
      <div><dt>created_at</dt><dd><time class=created_at datetime=2023-11-05>2023-11-05</time></dd></div>
      <div><dt>updated_at</dt><dd><time class=updated_at datetime=2024-11-15>2024-11-15</time></dd></div>
      <div>
        <dt>tags</dt>
        <dd>
          <nav class=tags>
            <ul>
            </ul>
          </nav>
        </dd>
      </div>
      <div>
        <dt>toc</dt>
        <dd>
          <button popovertarget="toc">open</button>
          <nav id=toc popover=manual>
            <h2>ToC</h2>
            <button popovertarget="toc" popovertargetaction="hide">❌</button>
            <ol>
              <li><a href="#intro">Intro</a>
              <li><a href="#ブラウザでキャッシュがヒットしない">「ブラウザでキャッシュがヒットしない」</a>
              <li><a href="#原因は検証方法">原因は検証方法</a>
              <ol>
                <li><a href="#navigation">Navigation</a>
                <li><a href="#reload">Reload</a>
              </ol>
              <li><a href="#force-reload">Force Reload</a>
              <li><a href="#正しい検証方法">正しい検証方法</a>
              <ol>
                <li><a href="#サブリソースの-revalidate">サブリソースの Revalidate</a>
              </ol>
              <li><a href="#おまけ">おまけ</a>
            </ol>
          </nav>
        </dd>
      </div>
    </dl>

    <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/article.css?220222_230717>
    <article>
      <h1><a href="">ブラウザでリロードしながらキャッシュの挙動を確認してる全ての開発者へ</a></h1>
      <section>
        <h2 id="intro"><a href="#intro">Intro</a></h2>
        <p>こういうタイトルを付けるのはあまり好きではないが、あえてこのようにした。
      </section>
      <section>
        <h2 id="ブラウザでキャッシュがヒットしない"><a href="#ブラウザでキャッシュがヒットしない">「ブラウザでキャッシュがヒットしない」</a></h2>
        <p>以下は、Web における Caching の FAQ だ。
        <ul>
          <li>サーバで <code translate=no>Cache-Control</code> を付与したのにキャッシュがヒットしない
          <li>サーバで <code translate=no>ETag</code> を付与したのに <code translate=no>If-None-Match</code> が送られない
          <li>サーバで <code translate=no>Last-Modified</code> を付与したのに <code translate=no>If-Modified-Since</code> が送られない
        </ul>
        <p>先日も、筆者が書いた MDN の Cache セクションで「記述が間違っているのでは?」と同様の質問を受けた。
        <ul>
          <li>
            Issue about the Age response header and the term &quot;Reload&quot; · Issue #29294 · mdn/content
            <ul>
              <li><a href="https://github.com/mdn/content/issues/29294#issuecomment-1746290336" target=_blank>https://github.com/mdn/content/issues/29294#issuecomment-1746290336</a>
            </ul>
          </li>
        </ul>
        <p>日本語で言えば、以下の例もこれに該当する。
        <ul>
          <li>
            Cache-Control ヘッダは仕様通り実装されていない? - Qiita
            <ul>
              <li><a href="https://qiita.com/shibukawa/items/bdf56e0adbc292666cfb#comment-f8af1c05a7b8abed7a82" target=_blank>https://qiita.com/shibukawa/items/bdf56e0adbc292666cfb#comment-f8af1c05a7b8abed7a82</a>
            </ul>
          </li>
        </ul>
        <p>本人が RFC などを確認していることがバイアスとして働き、「記述が間違っているのではないか」「仕様に準拠していないのでは」「バグがあるのではないか」と勘違いしがちだ。
        <p>確かに、これについてきちんと解説しているリソースは、決して多くはないかもしれない。そのため、昨年 MDN の Cache セクションを書き直した際にはこの件の解説を追加したし、自分が書いた本にもより詳細な解説を一節使って行っている。
        <ul>
          <li>
            HTTP caching - HTTP | MDN
            <ul>
              <li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching" target=_blank>https://developer.mozilla.org/en-US/docs/Web/HTTP/Caching</a>
            </ul>
          </li>
          <li>
            Browser API | Cache 解体新書
            <ul>
              <li><a href="https://zenn.dev/jxck/books/cache-anatomia/viewer/browser" target=_blank>https://zenn.dev/jxck/books/cache-anatomia/viewer/browser</a>
            </ul>
          </li>
        </ul>
        <p>今後、この記事を渡すだけで説明が終わるように、改めてまとめておく。
      </section>
      <section>
        <h2 id="原因は検証方法"><a href="#原因は検証方法">原因は検証方法</a></h2>
        <p>ブラウザごとの差なども含めて丁寧に話をすると記事が長くなるうえに、こうした検証で問い合わせてくる人が試しているのは大抵 Chrome なので、今回は Chrome に絞って話をする。
        <p>結論から言うと、これらの勘違いは全て「<em>ブラウザをリロードしながら DevTools の Network パネルを見ている</em>」ことが原因だ。
        <p>まず、ブラウザから発生するリクエストには、大きく 3 つある。(細かく分ければもっとあるが割愛)
        <ol>
          <li>Navigation
          <li>Reload
          <li>Force Reload (Super Reload)
        </ol>
        <section>
          <h3 id="navigation"><a href="#navigation">Navigation</a></h3>
          <p>Navigation とは、要するにリンクをクリックした場合に発生する画面遷移のリクエストだ。
          <p>このリクエストに対し、Fresh なレスポンスが Store されていれば Reuse される(意訳: ブラウザにキャッシュがあればヒットする)。
          <p>もし、<code translate=no>ETag</code> や <code translate=no>Last-Modified</code> が付与されていた場合は、Validation が発生する(意訳: <code translate=no>If-None-Match</code> や <code translate=no>If-Modified-Since</code> が付与されたリクエストが送られ、304 が返ってくれば再利用される)。
          <link rel=stylesheet property=stylesheet type=text/css href="https://www.jxck.io/assets/css/pre.css?220404_030403">
          <pre class=http data-code=http><code translate=no class=language-http>GET / HTTP/1.1
Host: example.com
If-None-Match: &quot;deadbeef&quot;
If-Modified-Since: Thu, 20 Feb 2020 20:20:20 GMT</code></pre>
          <p>これが RFC に書かれており、勘違いしている人が再現してほしい挙動だ。
        </section>
        <section>
          <h3 id="reload"><a href="#reload">Reload</a></h3>
          <p>Reload は、画面の更新だ。ブラウザの URL バーの隣にあるリロードボタンや、CMD-r / F5 などで実行される。
          <p>Reload はそもそも、何らかの理由で壊れた画面の修復や、最新情報への更新のために実装されている。したがって、「キャッシュが再利用されてほしくない」というのがユーザの要求であるため、当然のように、ブラウザが Fresh なレスポンスを Store していようがいまいが、バイパスして Origin にリクエストする。(意訳: サーバに最新の HTML を取りに行く)
          <p>つまり、いくら <code translate=no>max-age</code> が切れてなくても、Reload しながら DevTools でキャッシュがヒットする様子を見ることはできないのだ。
          <p>なお、リクエストは以下のようになる。
          <pre class=http data-code=http><code translate=no class=language-http>GET / HTTP/1.1
Host: example.com
Cache-Control: max-age=0
If-None-Match: &quot;deadbeef&quot;
If-Modified-Since: Thu, 20 Feb 2020 20:20:20 GMT</code></pre>
          <p>Conditional Request は行われているため、厳密にはブラウザに Response が保存されているが、Validation を強制していることになる(意訳: 304 が返ることはある)。
          <p><em>普段、結果の表示を Reload でデバッグしている癖でやってしまいがちではあるが、「Reload の挙動は Navigation とは違う」という点は、Cache 周りをいじっているなら念頭におきたい</em>。
          <p><code translate=no>max-age=0</code> を使っている理由は後述する。
        </section>
      </section>
      <section>
        <h2 id="force-reload"><a href="#force-reload">Force Reload</a></h2>
        <p>Force Reload は Super Reload などとも呼ばれ、Shift + Reload や DevTools の &quot;Disable Cache&quot; 相当の機能を有効にすると発生するものだ。
        <p>したがって、一般ユーザによる実行ではなく、開発者が実行するという意図で実装されている。
        <p>リクエストは以下のようになる。
        <pre class=http data-code=http><code translate=no class=language-http>GET / HTTP/1.1
Host: example.com
Cache-Control: no-cache</code></pre>
        <p><code translate=no>no-cache</code> を用いているため、「Origin に Validation を強制」していることがわかるだろう。しかし、<code translate=no>If-Modified-Since</code> や <code translate=no>Last-Modified</code> が消えていることから、Conditional Request ではない。つまり、Validation ではなく「Origin から最新の Response を取得する」という挙動になることがわかる。
        <p>意訳: ブラウザに <code translate=no>max-age</code> の切れていないキャッシュがあってもヒットしないし、サーバからは 304 が返ることもなく、必ず 200 が返る。
        <p>これこそが、「画面を最新の情報にする挙動」だろう、実際仕様的にもこれが最もそれに相応しい Request と言える。
        <p>では、なぜ Reload は <code translate=no>max-age=0</code> なのかというと、<code translate=no>no-cache</code> が仕様化されたのは、ブラウザが登場してからかなり経ってからだからだ。それ以前は <code translate=no>max-age=0</code> が使われていたため、ブラウザのリロードの実装もそのころから <code translate=no>max-age=0</code> を使っていた。後に <code translate=no>no-cache</code> が登場したからといって Reload の実装を変えると、クライアントが <code translate=no>no-cache</code> を送ってくることを想定していないサービスにおいては、互換性が壊れる可能性があり、現状でもそのままの実装となっている。
        <p>しかし、ブラウザが開発環境を兼ね、Devtools のような機能が入り、より複雑な開発が行われるようになると、より厳密な Reload である <code translate=no>no-cache</code> の実装が求められた。そこで、開発者向けに別途 Force Reload として実装された。Devtools に Disable Cache があるのは、Force Reload を強制するためだ。
      </section>
      <section>
        <h2 id="正しい検証方法"><a href="#正しい検証方法">正しい検証方法</a></h2>
        <p>では、「キャッシュの挙動」、正確には「ユーザが体験するキャッシュの挙動」はどのように検証すれば良いのだろうか?
        <p>答えは、最初に言ったように Navigation を用いることだ。
        <p>よくあるユースケースとして、例えば <code translate=no>/home.html</code> のレスポンスが以下だったとする。
        <pre class=http data-code=http><code translate=no class=language-http>HTTP/1.1 200 OK
...
Cache-Control: max-age=100
ETag: deadbeef
If-Modified-Since: Sat, 11 Nov 2023 11:11:11 GMT

&lt;!doctype html&gt;
...</code></pre>
        <p>このキャッシュがヒットするところが見たい場合は、以下のようなリンクをクリックし、そこに遷移すれば良い。もちろん、&quot;Disable Cache&quot; は無効にする。
        <pre class=css data-code=css><code translate=no class=language-css>&lt;a href=&quot;/home.html&quot;&gt;Home&lt;/a&gt;</code></pre>
        <p>もし、100s 以内ならキャッシュがヒットするだろうし、100s すぎたら以下のようなリクエストが飛ぶだろう。
        <pre class=http data-code=http><code translate=no class=language-http>GET /home.html HTTP/1.1
...
If-None-Match: deadbeef
If-Modified-Since: Sat, 11 Nov 2023 11:11:11 GMT</code></pre>
        <p>これで、仕様に記載されたリクエストを見ることができる。
        <section>
          <h3 id="サブリソースの-revalidate"><a href="#サブリソースの-revalidate">サブリソースの Revalidate</a></h3>
          <p>ただし、もう 1 つ注意点がある。
          <p>近年の Web では、サービスの実装バグなどによって表示が壊れるといった事象は、滅多に見られなくなってきた。つまり、ユーザがリロードをする理由の大半は、表示情報を最新にしたいケースと言える。
          <p>一方、現在の Web は 1 つのページが非常に多くのサブリソースに依存している。メインリソースである HTML の情報を最新にするために、多くのサブリソースを同時に更新するのは、非常に無駄な処理が多い。特に最近のサブリソースは、ビルド結果のハッシュを URL に付与し、キャッシュバスティングするケースが一般的だ。そうしたサブリソースは内容が一切変更されず、内容を変更する場合は URL が変更されることになる。
          <p>つまり、リロードで大量のサブリソースまで同時に更新するのは、大抵の場合無駄でしかないのだ。
          <p>そこで、「このリソースは更新されないからリロード時に取得し直す必要がない」と明示的に示す <code translate=no>immutable</code> が定義された。
          <ul>
            <li>
              RFC 8246 - HTTP Immutable Responses
              <ul>
                <li><a href="https://www.rfc-editor.org/rfc/rfc8246" target=_blank>https://www.rfc-editor.org/rfc/rfc8246</a>
              </ul>
            </li>
          </ul>
          <p>Firefox と Safari はこれを実装している。しかし Chrome は実装をしてない。
          <p>Chrome は独自の調査の結果、<code translate=no>immutable</code>がなくても Reload 時にサブリソースを Validation する必要はないという結論に至った。そのため、Reload 時にはメインリソースのみを再取得し、サブリソースは<code translate=no>immutable</code> がデフォルトという実装に変更されている。
          <p>この変更については、以下に詳細がある。
          <ul>
            <li>
              Chromium Blog: Reload, reloaded: faster and leaner page reloads
              <ul>
                <li><a href="https://blog.chromium.org/2017/01/reload-reloaded-faster-and-leaner-page_26.html" target=_blank>https://blog.chromium.org/2017/01/reload-reloaded-faster-and-leaner-page_26.html</a>
              </ul>
            </li>
          </ul>
          <p>つまり、先ほどの「リロードしながらキャッシュの挙動を観察する」においては、Chrome でサブリソースは常にキャッシュがヒットしている状態と考えることができる。この場合に出る以下のエラーメッセージが、かなり不親切なため、余計に混乱するかもしれないが、リクエストセクションの表示がないのはリクエストが発生すらしてないからだと思って良い。
          <pre><code translate=no>Provisional headers are shown, Disable cache to see full headers.</code></pre>
          <p>
            <picture>
              <source type=image/avif srcset=immutable-subresource-request.avif?240212_235833>
              <source type=image/webp srcset=immutable-subresource-request.webp?240313_215035>
              <img loading=lazy decoding=async src=immutable-subresource-request.png?240212_235833 alt="Provisional headers are shown, Disable cache to see full headers." width=1766 height=480>
            </picture>
          </p>
        </section>
      </section>
      <section>
        <h2 id="おまけ"><a href="#おまけ">おまけ</a></h2>
        <blockquote>
          <p><code translate=no>no-cache</code> という名前はキャッシュの仕様における最大の間違いだ、&quot;キャッシュしない&quot; は <code translate=no>no-store</code> なのでそちらを使うべきだ
        </blockquote>
        <p>や
        <blockquote>
          <p>世の中には <code translate=no>no-store</code> を無視するブラウザがあるから、<code translate=no>no-cache, no-store, max-age=0, must-revalidate, proxy-revalidate...</code> とすべきだ
        </blockquote>
        <p>といったこの話につきものの言説も、仕様を少しかじった人たちや、古い資料の知識から更新されてない人たちによって、決して正しいとは言えない解説とともに、いまだに更新されず流布している。
        <p>これらについても MDN および書籍のなかで解説しているので、世界の知識が更新されていくことを待つばかりだ。
      </section>
    </article>
  </main>
  <hr>

  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/footer.css?201223_011131>
  <footer>
    <p class=copyright><small>Copyright &copy; 2016 <a href=https://jxck.io>Jxck</a>. All Rights Reserved.</small> See <small><a href=https://jxck.io/policies/site.html>Site Policy</a> and <a href=https://jxck.io/policies/privacy.html>Privacy Policy</a>.</small></p>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5a6d3cda77d54761ba2f5c3f56d17ceb"}'></script><!-- End Cloudflare Web Analytics -->
  </footer>

</body>
</html>
