<!DOCTYPE html>
<html lang=ja>
<head prefix="og: http://ogp.me/ns# fb: http://ogp.me/ns/fb# article: http://ogp.me/ns/article#">
  <meta charset=utf-8>
  <meta name=viewport content="width=device-width,initial-scale=1">

  <link rel=author    href=https://jxck.io/humans.txt>
  <link rel=manifest  href=/manifest.webmanifest>
  <link rel=alternate href=/feeds/atom.xml type=application/atom+xml title=blog.jxck.io>
  <link rel=canonical href=https://blog.jxck.io/entries/2025-01-16/device-bound-session-credentials.html>

  <link rel=preload as=script href=https://www.jxck.io/assets/js/prism.js?210115_215132>
  <link rel=preload as=script href=https://www.jxck.io/assets/js/main.js?250125_005305>

  <script defer src=https://www.jxck.io/assets/js/prism.js?210115_215132></script>
  <script defer src=https://www.jxck.io/assets/js/main.js?250125_005305></script>

  <link rel=icon type=image/svg+xml sizes=any href=https://blog.jxck.io/assets/img/jxck.svg>
  <link rel=icon type=image/png sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.png>
  <link rel=icon type=image/png sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.png>
  <link rel=icon type=image/png sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.png>
  <link rel=icon type=image/png sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.png>
  <link rel=icon type=image/png sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.png>

  <link rel=icon type=image/webp sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.webp>
  <link rel=icon type=image/webp sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.webp>
  <link rel=icon type=image/webp sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.webp>
  <link rel=icon type=image/webp sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.webp>
  <link rel=icon type=image/webp sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.webp>

  <link rel=apple-touch-icon type=image/png sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.png>
  <link rel=apple-touch-icon type=image/png sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.png>
  <link rel=apple-touch-icon type=image/png sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.png>
  <link rel=apple-touch-icon type=image/png sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.png>
  <link rel=apple-touch-icon type=image/png sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.png>

  <link rel=apple-touch-icon type=image/webp sizes=120x120 href=https://blog.jxck.io/assets/img/jxck.120x120.webp>
  <link rel=apple-touch-icon type=image/webp sizes=300x300 href=https://blog.jxck.io/assets/img/jxck.300x300.webp>
  <link rel=apple-touch-icon type=image/webp sizes=600x600 href=https://blog.jxck.io/assets/img/jxck.600x600.webp>
  <link rel=apple-touch-icon type=image/webp sizes=1200x1200 href=https://blog.jxck.io/assets/img/jxck.1200x1200.webp>
  <link rel=apple-touch-icon type=image/webp sizes=3000x3000 href=https://blog.jxck.io/assets/img/jxck.3000x3000.webp>

  <meta name=author              content=Jxck>
  <meta name=description         content="Chrome チームより提案された Device Bound Session Credentials の実装が進み、Flag 付きで試すことができる。この提案の背景と、解決する問題、現時点での挙動について解説する。">
  <meta name=keywords            content="dbsc,cookie,security">
  <meta name=theme-color         content=#000000>

  <meta property=og:type         content=article>
  <meta property=og:url          content=https://blog.jxck.io/entries/2025-01-16/device-bound-session-credentials.html>
  <meta property=og:title        content="Cookie Theft 対策と Device Bound Session Credentials | blog.jxck.io">
  <meta property=og:site_name    content=blog.jxck.io>
  <meta property=og:description  content="Chrome チームより提案された Device Bound Session Credentials の実装が進み、Flag 付きで試すことができる。この提案の背景と、解決する問題、現時点での挙動について解説する。">
  <meta property=og:image        content=https://blog.jxck.io/assets/img/jxck.600x600.png>

  <meta name="Hatena::Bookmark" content="nocomment">
  <link rel="author" href="http://www.hatena.ne.jp/Jxck/" />


  <script type=application/ld+json>
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "mainEntityOfPage":{
      "@type":"WebPage",
      "@id":"https://blog.jxck.io"
    },
    "headline": "Cookie Theft 対策と Device Bound Session Credentials | blog.jxck.io",
    "image": [
      "https://www.jxck.io/assets/img/jxck.png",
      "https://logo.jxck.io/jxck.1200x1200.png"
    ],
    "datePublished": "2025-01-16T08:00:00+08:00",
    "dateModified": "2025-01-16T08:00:00+08:00",
    "author": {
      "@type": "Person",
      "name": "Jxck",
      "image": "https://blog.jxck.io/assets/img/jxck.png"
    },
    "publisher": {
      "@type": "Organization",
      "name": "Jxck",
      "logo": {
        "@type": "ImageObject",
        "url": "https://logo.jxck.io/jxck.120x120.png",
        "height": 120,
        "width": 120
      }
    },
    "description": "Chrome チームより提案された Device Bound Session Credentials の実装が進み、Flag 付きで試すことができる。この提案の背景と、解決する問題、現時点での挙動について解説する。"
  }
  </script>

  <title>Cookie Theft 対策と Device Bound Session Credentials | blog.jxck.io</title>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/body.css?240701_012822>
</head>
<body>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/header.css?230926_134917>
  <header>
    <nav>
      <ul>
        <li><a href=https://blog.jxck.io      ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/blog.svg?160301_215351   title=blog   alt="blog logo" class=logo></a>
        <li><a href=/search                   ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/search.svg?190421_130410 title=search alt=search></a>
        <li><a href=.                         ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/up.svg?160831_002319     title=up     alt="move to parent directory"></a>
        <li><a href=/feeds/atom.xml           ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/rss.svg?160227_124312    title=rss    alt="rss feed"></a>
        <li><a href=https://jxck.io/humans.txt><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/humans.svg?160831_002319 title=humans alt=huamns.txt></a>
        <li><a href=https://jxck.io           ><img width=30 height=30 loading=eager src=https://www.jxck.io/assets/img/jxck.svg?190123_200004   title=jxck   alt="jxck logo" class=logo></a>
      </ul>
    </nav>
  </header>

  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/markdown.css?220304_061221>
  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/main.css?201223_011131>
  <main>
    <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/info.css?240713_033306>
    <dl class=info>
      <div><dt>created_at</dt><dd><time class=created_at datetime=2025-01-16>2025-01-16</time></dd></div>
      <div><dt>updated_at</dt><dd><time class=updated_at datetime=2025-01-16>2025-01-16</time></dd></div>
      <div>
        <dt>tags</dt>
        <dd>
          <nav class=tags>
            <ul>
              <li><a href="/tags#dbsc">dbsc</a>
              <li><a href="/tags#cookie">cookie</a>
              <li><a href="/tags#security">security</a>
            </ul>
          </nav>
        </dd>
      </div>
      <div>
        <dt>toc</dt>
        <dd>
          <button popovertarget="toc">open</button>
          <nav id=toc popover=manual>
            <h2>ToC</h2>
            <button popovertarget="toc" popovertargetaction="hide">❌</button>
            <ol>
              <li><a href="#intro">Intro</a>
              <li><a href="#背景">背景</a>
              <li><a href="#cookie-theft-によるインシデント">Cookie Theft によるインシデント</a>
              <ol>
                <li><a href="#マルウェア対策">マルウェア対策</a>
                <li><a href="#フィッシング対策">フィッシング対策</a>
                <li><a href="#cookie-theft-対策">Cookie Theft 対策</a>
              </ol>
              <li><a href="#cookie-をどう守るか">Cookie をどう守るか</a>
              <ol>
                <li><a href="#demonstrating-proof-of-possession-in-the-browser-application-bpop">Demonstrating Proof-of-Possession in the Browser Application (BPoP)</a>
                <li><a href="#tpm-による管理">TPM による管理</a>
              </ol>
              <li><a href="#device-bound-session-credentials">Device Bound Session Credentials</a>
              <ol>
                <li><a href="#sec-session-registration">Sec-Session-Registration</a>
                <li><a href="#sec-session-response">Sec-Session-Response</a>
                <li><a href="#session-registration-instructions-json">Session Registration Instructions JSON</a>
                <li><a href="#refresh-request">Refresh Request</a>
              </ol>
              <li><a href="#session-の終了">Session の終了</a>
              <li><a href="#js-api">JS API</a>
              <li><a href="#device-bound-session-credentials-for-enterprise">Device Bound Session Credentials for Enterprise</a>
              <li><a href="#outro">Outro</a>
              <li><a href="#demo">DEMO</a>
              <li><a href="#resources">Resources</a>
            </ol>
          </nav>
        </dd>
      </div>
    </dl>

    <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/article.css?220222_230717>
    <article>
      <h1><a href="">Cookie Theft 対策と Device Bound Session Credentials</a></h1>
      <section>
        <h2 id="intro"><a href="#intro">Intro</a></h2>
        <p>Chrome チームより提案された Device Bound Session Credentials の実装が進み、Flag 付きで試すことができる。
        <p>この提案の背景と、解決する問題、現時点での挙動について解説する。
      </section>
      <section>
        <h2 id="背景"><a href="#背景">背景</a></h2>
        <p>2FA や Passkey の普及により、認証部分はかなりセキュアになってきた。インシデントによりパスワードが漏洩しても、それだけでなりすましを成立させるのも困難になっている。
        <p>そこで攻撃者の注目を集めているのが、Cookie の窃取(Cookie Theft)だ。
        <p>認証がいかに堅牢になっても、有効な Session Cookie を盗むことができれば、その値を <code translate=no>Cookie</code> フィールドに付与してリクエストするだけで、なりすましを成立させることができる。
        <p>いわゆる Session Cookie は、Proof of Authentication として実装されていることがほとんどであり、その有効期限内はユーザの持つ権限と同等の操作が可能になる。そして Bearer Token であるため、誰が送ってもその効果を発揮してしまうのだ。
        <p>いかに Session Cookie を守るのかは、今後の Web セキュリティの 1 つの重要なトピックと言える。
      </section>
      <section>
        <h2 id="cookie-theft-によるインシデント"><a href="#cookie-theft-によるインシデント">Cookie Theft によるインシデント</a></h2>
        <p>HTTPS が前提となり通信が暗号化されているため、Cookie を盗むのは難しいと考えるかもしれない。
        <p>しかし、Cookie Theft の攻撃ベクタは、通信の Person in the Middle ではなく、マルウェアやフィッシングにトレンドを移している。
        <p>ちょうど世間を騒がせた DMM のビットコイン流出事件も、この手法による Session Cookie の窃取が突破口になっているようだ。
        <ul>
          <li>
            北朝鮮を背景とするサイバー攻撃グループ TraderTraitor による暗号資産関連事業者を標的としたサイバー攻撃について - 令和 6 年 12 月 24 日 警察庁
            <ul>
              <li><a href="https://www.npa.go.jp/bureau/cyber/pdf/020241224_pa.pdf" target=_blank>https://www.npa.go.jp/bureau/cyber/pdf/020241224_pa.pdf</a>
            </ul>
          </li>
        </ul>
        <blockquote>
          <p>...同サイバー攻撃グループは、Ginco のウォレット管理システムへのアクセス権を保有する従業員に、GitHub 上に保管された採用前試験を装った悪意ある Python スクリプトへの URL を送付しました。被害者は、この Python コードを自身の GitHub ページにコピーし、その後、侵害されました。
          <p>...侵害を受けた従業員になりすますためにセッションクッキーの情報を悪用し、Ginco の暗号化されていない通信システムへのアクセスに成功しました。
        </blockquote>
        <p>つまり、GitHub 上の Python スクリプトを実行させ、有効な Session Cookie を窃取。それを用いたなりすましで、ビットコインの漏洩を成立させたとしている。
        <section>
          <h3 id="マルウェア対策"><a href="#マルウェア対策">マルウェア対策</a></h3>
          <p>Cookie はあくまでブラウザがローカルに保存している値であるため、ユーザの権限でインストールされたマルウェアは、保存されたファイルにアクセスできてしまうのだ。
          <p>なお、昔のブラウザは、それこそ平文テキストで保存されていたりもしたが、さすがに今はそこまで簡易ではない。
          <p>例えば Chrome は様々なデータをローカルの SQLite に保存することが多いが、Cookie に関しては Mac の Keychain, Linux の Kwallet など、アプリからしかアクセスできない安全な領域に保存している。
          <p>ところが Windows は、DPAPI というログインユーザ権限で実行されたアプリからはアクセスできてしまう領域にあるため、マルウェアによる窃取の危険性があった。
          <p>そこで、Windows でも App-Bound Encryption という機能で、これを保護するよう変更が入った。
          <ul>
            <li>
              Improving the security of Chrome cookies on Windows
              <ul>
                <li><a href="https://security.googleblog.com/2024/07/improving-security-of-chrome-cookies-on.html" target=_blank>https://security.googleblog.com/2024/07/improving-security-of-chrome-cookies-on.html</a>
              </ul>
            </li>
          </ul>
          <p>DMM の攻撃発覚が 2024/3 で、このエントリが 2024/7 公開なので、事件が契機だったのか?と勘ぐってしまったが、作業のタイムラインを見ると 2021 年頃から継続的に作業をしているので、たまたま重なっただけのようにも見える。
          <ul>
            <li>
              add application bound encryption primitives for chrome [40227925] - Chromium
              <ul>
                <li><a href="https://issues.chromium.org/issues/40227925" target=_blank>https://issues.chromium.org/issues/40227925</a>
              </ul>
            </li>
          </ul>
          <p>事件の詳細は公開されている以上にわからないが、もし仮に Ginco の社員が使っていたのが Windows Chrome であり、この変更が間に合っていたら 482 億の流出が防げていた可能性があるのなら、このパッチのもたらす影響の大きさがよくわかる。
        </section>
        <section>
          <h3 id="フィッシング対策"><a href="#フィッシング対策">フィッシング対策</a></h3>
          <p>マルウェアよりも簡単なのは、ユーザの方を騙す手口だ。(DMM の攻撃も、ソーシャル経由ではあるが)
          <p>フィッシングサイトでログイン画面を偽装し、ID/Password を窃取する方法は知られていたが、二段階認証等があれば Password だけを盗まれても攻撃のリスクは減らせる。しかし、入力された ID/Password を裏で Proxy して本サイトに転記、同様に TOTP Token などもユーザに求めてそれを転記すれば、フィッシングサイトの裏にいる攻撃者が、ログイン済みの Cookie を受けとれる可能性もある。
          <p>ユーザは本サイトにリダイレクトしておけば、「なんかログインできなかった」ともう一度正規のログインを行うだけなので、攻撃されたことすら気づけないかもしれない。
          <p>ドメイン名を見て偽のサイトであることに気づくのが、ユーザができる第一の策だ。長いサブドメインを使って、部分的に本物に見せかける攻撃を防ぐために、モバイルブラウザが eTLD+1 のみの短縮表示を始めたのも、こうした理由が大きい。
          <p>それでも、人間の注意には限界があるので、各ベンダはパスワードマネージャを推奨し、機械的に偽ドメインに気付けるようにユーザへの啓蒙を進めている。パスワードマネージャの普及が求められるのは、簡単な文字列が再利用されるのを防ぐだけではない。Passkey 普及のゴールも、どちらかというとパスワードマネージャの普及にあると筆者は考えている。
        </section>
        <section>
          <h3 id="cookie-theft-対策"><a href="#cookie-theft-対策">Cookie Theft 対策</a></h3>
          <p>Cookie が Bearer Token である以上、サーバが受け取った Cookie が有効なものであっても、それが窃取されたものかどうか、確信を持つことはできない。
          <p>そこで、Session に紐づけてメタ情報を保存しておき、ユーザの行動に発生する変化を監視する方法が知られている。
          <p>具体的には以下のような情報を用いる。
          <ul>
            <li><code translate=no>IP</code>
            <li><code translate=no>User-Agent</code>
            <li><code translate=no>Accept</code>
            <li><code translate=no>Accept-Language</code>
            <li><code translate=no>Sec-Fetch-*</code>
          </ul>
          <p>これらの値をリクエストから収集し、Cookie を発行した時点と値が変わっていれば、それは窃取した他のユーザから使われている可能性が高い。
          <p>もちろん、移動すれば IP は変わるし、アップデートすれば User-Agent は変わる。つまり、偽陽性があるため確実な検出はできないが、再認証や CAPTCHA を挟むことで安全側に倒し、リスクを低減する方式だ。
          <p>(Private Relay を有効にしていると、Google サーチで CAPTCHA が頻出するなど、不便もあるため閾値は難しいが。)
          <p>この手法について具体的な施策は、あまり公開されることがなかった。しかし、去年 Slack が、タイムスタンプなどの要素も追加した、より強固な対策の実施内容を共有しているため参考になる。
          <ul>
            <li>
              Catching Compromised Cookies - Engineering at Slack
              <ul>
                <li><a href="https://slack.engineering/catching-compromised-cookies/" target=_blank>https://slack.engineering/catching-compromised-cookies/</a>
              </ul>
            </li>
          </ul>
        </section>
      </section>
      <section>
        <h2 id="cookie-をどう守るか"><a href="#cookie-をどう守るか">Cookie をどう守るか</a></h2>
        <p>「盗まれないようにする」のと同じように、「盗まれても大丈夫にする」という対策も考えられている。
        <p>根本的には、「送信してきたのが正当な所有者である」ことを証明できればよく、ここでは公開鍵暗号方式が応用できる。OAuth では、DPoP や MTLS のような仕組みで Proof of Possession (PoP) を実現し、Sender Constrained な Token にする方式があるが、発想はそれと同じだ。
        <p>このような方式を取る場合、問題になるのは鍵 (Private Key) の管理だ。クライアントに鍵を保持するなら、それが盗まれる可能性を考える必要があり、そこが安全性の下限になる。
        <p>ちなみに、JS で鍵を生成し IndexedDB に入れる実装としては、以下がある。もちろん、JS で取得可能のとこに鍵が保存されていることになる。
        <ul>
          <li>
            session-lock - Home
            <ul>
              <li><a href="https://session-lock.keyri.com/" target=_blank>https://session-lock.keyri.com/</a>
            </ul>
          </li>
        </ul>
        <p>Web の場合、そもそも通信自体が TLS で鍵交換しているのだから、そこに紐づけて Token を管理できないかという発想で、Token Binding という仕様が議論された時期もある。
        <ul>
          <li>
            RFC 8473 - Token Binding over HTTP
            <ul>
              <li><a href="https://datatracker.ietf.org/doc/html/rfc8473" target=_blank>https://datatracker.ietf.org/doc/html/rfc8473</a>
            </ul>
          </li>
        </ul>
        <p>これを用いれば Cookie や OAuth の Token などに対して、ブラウザが管理している鍵 (から Export された専用の鍵) を用いて、PoP を提供できると期待されていた。
        <p>しかし、TLS との連携をデプロイするのは必ずしも容易とはいえなかった。例えば、一般的な構成では TLS の終端はアプリケーションサーバとは別のマシンで行われることが多い (最近だと CDN など)。
        <p>また、そもそもネットワーク的な意味でのレイヤを跨いでいるため、アプリケーション (フレームワーク) の既存の設計にも馴染まない部分が多い。
        <p>なにより、TLS のライフサイクル (ハンドシェイク) と、アプリが管理するセッションのライフサイクル (ログイン~ログアウト) などが乖離しているため、例えばログアウトしたから Binding を切りたいといった要求に対して、微妙な歪みが生じたのだ。
        <section>
          <h3 id="demonstrating-proof-of-possession-in-the-browser-application-bpop"><a href="#demonstrating-proof-of-possession-in-the-browser-application-bpop">Demonstrating Proof-of-Possession in the Browser Application (BPoP)</a></h3>
          <p>Microsoft は DPoP に似た BPoP というプロトコルを提案していた。といっても、Explainer を書いただけで終わっている。
          <ul>
            <li>
              MSEdgeExplainers/BindingContext/explainer.md at main · MicrosoftEdge/MSEdgeExplainers
              <ul>
                <li><a href="https://github.com/MicrosoftEdge/MSEdgeExplainers/blob/main/BindingContext/explainer.md" target=_blank>https://github.com/MicrosoftEdge/MSEdgeExplainers/blob/main/BindingContext/explainer.md</a>
              </ul>
            </li>
          </ul>
          <p>これは、ほぼこのあと解説する DBSC と同じようなものであり、すでに MS は DBSC の方に協力する方向になっているようなので、この仕様の解説は省く。
          <ul>
            <li>
              DBSC (Device Bound Session Credentials) · Issue #106 · WICG/proposals
              <ul>
                <li><a href="https://github.com/WICG/proposals/issues/106#issuecomment-1624111068" target=_blank>https://github.com/WICG/proposals/issues/106#issuecomment-1624111068</a>
              </ul>
            </li>
            <li>
              Device Bound Session Credentials · Issue #912 · mozilla/standards-positions
              <ul>
                <li><a href="https://github.com/mozilla/standards-positions/issues/912#issuecomment-2420716960" target=_blank>https://github.com/mozilla/standards-positions/issues/912#issuecomment-2420716960</a>
              </ul>
            </li>
          </ul>
        </section>
        <section>
          <h3 id="tpm-による管理"><a href="#tpm-による管理">TPM による管理</a></h3>
          <p>通常、TLS の鍵、特に CA や GAFA レベルのサービスで用いる秘密鍵は、漏洩時の影響が大きすぎるため「プルトニウムと同等のセキュリティレベルで扱う」と冗談めいて言われるくらい、厳重に管理される必要がある。そこで、鍵の生成は一般に行われる OpenSSL の <code translate=no>genrsa</code> のようなカジュアルな方法ではなく、専用ハードウェアモジュールの中で行われる。
          <p>このようなモジュールは HSM (Hardware Security Module) と呼ばれ、内部で生成された秘密鍵は、そもそも取り出すことができない。もし壊して取り出そうとすると、鍵そのものが失われる(耐タンパ性)。署名等の計算が必要な場合は、モジュールに対してリクエストすると、鍵を用いた計算結果が中で行われ、計算結果だけが返ってくるといった仕組みだ。これなら、鍵の窃取に対して堅牢になる。しかし、こうしたモジュールは非常に高価で、扱うのも専門業者くらいだった。
          <p>ところが、近年ではデバイスにおける TPM (Trusted Platform Module) の実装が広がっている。これは、基盤に埋め込まれ隔離されたハードウェアで、秘密鍵を生成/管理できる、安価な HSM のようなものと言える。
          <p>現状は、全てのデバイスが TPM を持っているとは限らないが、Win11 からは TPM を持つことが必須になり、Chrome の調査では Win ユーザの 60% 程度は TPM が利用できる状態にあると報告され、徐々に普及が進んでいると言える。
          <p>もし TPM を持たないデバイスの場合は、ソフトウェアでエミュレートすることでフォールバックが可能だ。そちらは TPM ほど安全ではないにせよ、全体のセキュリティの底上げにはなる。
          <p>もちろん、TPM に対して署名を依頼することは他のユーザ(特に、より権限の高いユーザ)でも可能であり、攻撃を完全には防げない。しかし、そのような悪意のあるアプリの動きは、マルウェアとして検知するのがある程度容易であるため、総合的には対策が可能とされている。
          <p>少なくとも、この仕組みを Cookie に持ち込めれば、従来よりはかなり安全になるだろう。
        </section>
      </section>
      <section>
        <h2 id="device-bound-session-credentials"><a href="#device-bound-session-credentials">Device Bound Session Credentials</a></h2>
        <p>以上を踏まえ、Cookie の PoP を TPM に保存した鍵で提供するという方式が、Device Bound Session Credentials (DBSC) の提案の中核だ。
        <ul>
          <li>
            WICG/dbsc
            <ul>
              <li><a href="https://github.com/WICG/dbsc" target=_blank>https://github.com/WICG/dbsc</a>
            </ul>
          </li>
          <li>
            Chromium Blog: Fighting cookie theft using device bound sessions
            <ul>
              <li><a href="https://blog.chromium.org/2024/04/fighting-cookie-theft-using-device.html" target=_blank>https://blog.chromium.org/2024/04/fighting-cookie-theft-using-device.html</a>
            </ul>
          </li>
        </ul>
        <p>完全に Cookie とは別の仕組みにすると、デプロイ負荷が高いと広がらないため、Cookie との互換性も持たせるように設計されている。
        <p>ここからは、実際に Chrome のフラグを有効にし、その挙動を確認しながら基本的な仕様を見ていく。なお、現状は Windows でしか動かなかったため、以下は Win11 / Chrome 131 で検証している。
        <ul>
          <li>chrome://flags/#enable-standard-device-bound-session-credentials
        </ul>
        <section>
          <h3 id="sec-session-registration"><a href="#sec-session-registration">Sec-Session-Registration</a></h3>
          <p>ここでいう Session の開始は、ログインフローの最後に Authorized Session が開始する時点などを想定している。
          <p>つまり、ログイン認証のレスポンスで <code translate=no>Sec-Session-Registration</code> を返すことで、クライアントに鍵ペアの生成をリクエストできる。
          <link rel=stylesheet property=stylesheet type=text/css href="https://www.jxck.io/assets/css/pre.css?220404_030403">
          <pre class=http data-code=http><code translate=no class=language-http>HTTP/1.1 302 Found
Location: /
Sec-Session-Registration: (RS256 ES256);challenge=&quot;challenge_value&quot;;path=&quot;session&quot;</code></pre>
          <p>構造は SFV になっており、最初は暗号方式のリストから始まり、後で用いるチャレンジと、エンドポイントのパスが含まれている。
        </section>
        <section>
          <h3 id="sec-session-response"><a href="#sec-session-response">Sec-Session-Response</a></h3>
          <p>レスポンスを受け取ったクライアントは、TPM で生成した鍵を JWT でシリアライズし、<code translate=no>Sec-Session-Response</code> に付与して、先程の指定したエンドポイントにリクエストする。body はない。
          <p>ブラウザが内部的に送るリクエストのため、Dev Tools の Network タブに今は出ない。早く内部デバッガ (chrome://dbsc-internals)が欲しいところだ。
          <pre class=http data-code=http><code translate=no class=language-http>POST /session HTTP/1.1
Host: example.com
Sec-Session-Response: eyJ...</code></pre>
          <p>実際に送られてきた JWT は以下のようなものだった。
          <pre class=js data-code=js><code translate=no class=language-js>// Header
{
  &quot;typ&quot;: &quot;JWT&quot;,
  &quot;alg&quot;: &quot;RS256&quot;
}
// Payload
{
  &quot;aud&quot;: &quot;https://example.com/session&quot;,
  &quot;jti&quot;: &quot;challenge_value&quot;,
  &quot;iat&quot;: &quot;1736267817&quot;,
  &quot;key&quot;: {
    &quot;e&quot;: &quot;AQAB&quot;,
    &quot;kty&quot;: &quot;RSA&quot;,
    &quot;n&quot;: &quot;oPJngC...&quot;
  },
  &quot;authorization&quot;: &quot;&quot;
}
// Signature
&quot;gkkfn2VDUQzJHv7...&quot;</code></pre>
          <p>この鍵をサーバ側で保存する。
          <p>---
          <p>TODO: ここから下はまだ Chrome には実装されてなかったため、挙動が確認できていない。
          <p><a href="https://github.com/drubery/dbsc/issues/88#issuecomment-2591379358" target=_blank>https://github.com/drubery/dbsc/issues/88#issuecomment-2591379358</a>
          <p>現状は、仕様ベースで解説し、挙動が確認でき次第更新する。
        </section>
        <section>
          <h3 id="session-registration-instructions-json"><a href="#session-registration-instructions-json">Session Registration Instructions JSON</a></h3>
          <p>このリクエストに対し、サーバは以下のような JSON を body で送る。
          <pre class=json data-code=json><code translate=no class=language-json>HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 65535
Set-Cookie: __Host-session-id=deadbeef; Path=/; Secure; HttpOnly; Max-Age=604800

{
  &quot;session_identifier&quot;: &quot;b434736b1daa31f7&quot;,
  &quot;refresh_url&quot;: &quot;/refresh&quot;,
  &quot;scope&quot;: {
    &quot;origin&quot;: &quot;example.com&quot;
  },
  &quot;credentials&quot;: [{
    &quot;type&quot;: &quot;cookie&quot;,
    &quot;name&quot;: &quot;__Host-session-id&quot;,
    &quot;attributes&quot;: &quot;Path=/; Secure; HttpOnly; Max-Age=604800&quot;
  }]
}</code></pre>
          <p>ここで <code translate=no>Set-Cookie</code> する Cookie は、従来の Cookie と同じだ。
          <p>つまり、従来の Cookie のデプロイと互換性があり、セッション管理自体を新しいヘッダなどに移行する必要はない。
        </section>
        <section>
          <h3 id="refresh-request"><a href="#refresh-request">Refresh Request</a></h3>
          <p>この Cookie の期限が切れたあと、Cookie を必要とするリクエストを実施する際に、ブラウザは DBSC の Refresh をサーバに対して実施することになる。
          <p>つまり、<code translate=no>Max-Age</code> が経過した後に <code translate=no>/</code> にアクセスする場合は、そのアクセスを一旦保留して、裏側で先程指定された <code translate=no>refresh_url</code> である <code translate=no>/refresh</code> に以下のようなリクエストを行う。
          <pre class=http data-code=http><code translate=no class=language-http>POST /refresh HTTP/1.1
Host: example.com
Sec-Session-Id: b434736b1daa31f7</code></pre>
          <p>これが、「割り当てられた Session の Credential の Refresh」を要求している。
          <p>サーバはこれに対して、検証用の Challenge を返す。
          <pre class=http data-code=http><code translate=no class=language-http>HTTP/1.1 401 Unauthorized
Sec-Session-Challenge: &quot;challenge_value&quot;;id=&quot;b434736b1daa31f7&quot;</code></pre>
          <p>クライアントは、秘密鍵を用いてこれに応答する。
          <pre class=http data-code=http><code translate=no class=language-http>POST /refresh HTTP/1.1
Sec-Session-Response: JWT proof</code></pre>
          <p>検証に成功すれば、再度 <code translate=no>Set-Cookie</code> することで Cookie を更新することができる。
          <p>レスポンスとして、設定時と全く同じ JSON を返すことで更新が可能だ。
          <pre class=http data-code=http><code translate=no class=language-http>HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 65535
Set-Cookie: __Host-session-id=deadbeef; Path=/; Secure; HttpOnly; Max-Age=604800

{
  &quot;session_identifier&quot;: &quot;b434736b1daa31f7&quot;,
  &quot;refresh_url&quot;: &quot;/refresh&quot;,
  &quot;scope&quot;: {
    &quot;origin&quot;: &quot;example.com&quot;
  },
  &quot;credentials&quot;: [{
    &quot;type&quot;: &quot;cookie&quot;,
    &quot;name&quot;: &quot;__Host-session-id&quot;,
    &quot;attributes&quot;: &quot;Path=/; Secure; HttpOnly; Max-Age=604800&quot;
  }]
}</code></pre>
          <p>これを受け取ったクライアントは、保留していたリクエストをすべて送信することになる。
          <p>また、このリクエストはクライアントが Refresh を要求してこなくても送信できるため、期限が切れる前に Credential を新しくしておくことで、リクエストの保留を避けることも可能だ。
          <p>この Refresh の要求をサーバのタイミングでできることは、単なる更新だけでなく、最初に問題視した「Cookie を送ってきているのは想定したクライアントか?」を確認する手段に使うことができることを意味する。
        </section>
      </section>
      <section>
        <h2 id="session-の終了"><a href="#session-の終了">Session の終了</a></h2>
        <p>もし (DBSC における) Session を終了する場合は、リフレッシュのレスポンスで以下のように返す。
        <pre class=http data-code=http><code translate=no class=language-http>{
  &quot;session_identifier&quot;: &quot;b434736b1daa31f7&quot;,
  &quot;continue&quot;: false
}</code></pre>
        <p>もしくは <code translate=no>Clear-Site-Data: &quot;storage&quot;</code> を用いることも可能だ。
        <p>これにより、ブラウザは Session のために内部に保持したリソースを削除する。
        <p>以降は、削除した Session に対する <code translate=no>Sec-Session-Response</code> をクライアントが送ってくることも、<code translate=no>Sec-Session-Challenge</code> に応答することもなくなる。
      </section>
      <section>
        <h2 id="js-api"><a href="#js-api">JS API</a></h2>
        <p>Explainer では JS API の可能性についても触れられている。
        <p>しかし、現状はあくまで構想だけであり、Chrome も初期の実装では JS API はスコープから外しているため、実装されたら検証する。
      </section>
      <section>
        <h2 id="device-bound-session-credentials-for-enterprise"><a href="#device-bound-session-credentials-for-enterprise">Device Bound Session Credentials for Enterprise</a></h2>
        <p>この仕組みを拡張し、Enterprise 領域で発生する様々な要求をカバーできる可能性にも言及されている。
        <ul>
          <li>
            Device Bound Session Credentials for Enterprise - explainer
            <ul>
              <li><a href="https://github.com/drubery/dbsc/blob/main/DBSCE/Overview.md" target=_blank>https://github.com/drubery/dbsc/blob/main/DBSCE/Overview.md</a>
            </ul>
          </li>
        </ul>
        <p>DBSC では、既にマルウェアに汚染されていた場合、Credential の生成部分が改竄される可能性があるとし、主に鍵の生成部分についてカスタマイズできる余地を入れるというのが、本旨になっているようだ。
        <p>MS はこれまで、BindingContext という独自の仕様を提案していたが、今後は作業のフォーカスを DBSC(E) に移していくとしている。
        <ul>
          <li>
            MSEdgeExplainers/BindingContext/explainer.md at main · MicrosoftEdge/MSEdgeExplainers
            <ul>
              <li><a href="https://github.com/MicrosoftEdge/MSEdgeExplainers/blob/main/BindingContext/explainer.md" target=_blank>https://github.com/MicrosoftEdge/MSEdgeExplainers/blob/main/BindingContext/explainer.md</a>
            </ul>
          </li>
        </ul>
        <p>もちろん、DBSC が前提としてあるため、そちらがある程度進んでからになるだろう。
        <p>よってここでは、紹介のみに留める。
      </section>
      <section>
        <h2 id="outro"><a href="#outro">Outro</a></h2>
        <p>Cookie Theft 対策の新しい提案である Device Bound Session Credentials について解説した。
        <p>挙動未確認の部分については、実装されてから確認し、本エントリを更新する。
      </section>
      <section>
        <h2 id="demo"><a href="#demo">DEMO</a></h2>
        <p>WIP: 動作するデモを以下に用意した。
        <ul>
          <li><a href="https://labs.jxck.io/device-bound-session-credentials/index.html" target=_blank>https://labs.jxck.io/device-bound-session-credentials/index.html</a>
        </ul>
      </section>
      <section>
        <h2 id="resources"><a href="#resources">Resources</a></h2>
        <ul>
          <li>Spec
          <li>
            Explainer
            <ul>
              <li>
                WICG/dbsc
                <ul>
                  <li><a href="https://github.com/WICG/dbsc" target=_blank>https://github.com/WICG/dbsc</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>Requirements Doc
          <li>
            Mozilla Standard Position
            <ul>
              <li>
                Device Bound Session Credentials · Issue #912 · mozilla/standards-positions
                <ul>
                  <li><a href="https://github.com/mozilla/standards-positions/issues/912" target=_blank>https://github.com/mozilla/standards-positions/issues/912</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            Webkit Position
            <ul>
              <li>
                Device Bound Session Credentials · Issue #281 · WebKit/standards-positions
                <ul>
                  <li><a href="https://github.com/WebKit/standards-positions/issues/281" target=_blank>https://github.com/WebKit/standards-positions/issues/281</a>
                  <li>デバイスバックアップからのリストア時の UX の低下を懸念している
                  <li>TPM を必須にしないことで緩和できるが、それ以外で流出を防ぐあらゆることをすべき
                </ul>
              </li>
            </ul>
          </li>
          <li>TAG Design Review
          <li>
            Intents
            <ul>
              <li>
                Intent to Prototype: Device Bound Session Credentials (DBSC)
                <ul>
                  <li><a href="https://groups.google.com/a/chromium.org/g/blink-dev/c/xvZJPpXNS8Y/m/Z1gU6U-UAAAJ" target=_blank>https://groups.google.com/a/chromium.org/g/blink-dev/c/xvZJPpXNS8Y/m/Z1gU6U-UAAAJ</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            Chrome Platform Status
            <ul>
              <li>
                Device Bound Session Credentials - Chrome Platform Status
                <ul>
                  <li><a href="https://chromestatus.com/feature/5140168270413824" target=_blank>https://chromestatus.com/feature/5140168270413824</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>WPT (Web Platform Test)
          <li>DEMO
          <li>
            Blog
            <ul>
              <li>
                Chromium Blog: Fighting cookie theft using device bound sessions
                <ul>
                  <li><a href="https://blog.chromium.org/2024/04/fighting-cookie-theft-using-device.html" target=_blank>https://blog.chromium.org/2024/04/fighting-cookie-theft-using-device.html</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>Presentation
          <li>
            Issues
            <ul>
              <li>
                DBSC (Device Bound Session Credentials) · Issue #106 · WICG/proposals
                <ul>
                  <li><a href="https://github.com/WICG/proposals/issues/106" target=_blank>https://github.com/WICG/proposals/issues/106</a>
                </ul>
              </li>
              <li>
                Create DBSC in network service [41495201] - Chromium
                <ul>
                  <li><a href="https://issues.chromium.org/issues/41495201" target=_blank>https://issues.chromium.org/issues/41495201</a>
                </ul>
              </li>
            </ul>
          </li>
          <li>
            Other
            <ul>
              <li>
                MSEdgeExplainers/BindingContext/explainer.md at main · MicrosoftEdge/MSEdgeExplainers
                <ul>
                  <li><a href="https://github.com/MicrosoftEdge/MSEdgeExplainers/blob/main/BindingContext/explainer.md" target=_blank>https://github.com/MicrosoftEdge/MSEdgeExplainers/blob/main/BindingContext/explainer.md</a>
                </ul>
              </li>
              <li>
                DBSC public drive - Google ドライブ
                <ul>
                  <li><a href="https://drive.google.com/drive/folders/1xL5GnXS6XtBlf96UROkW4gAbvsInB-Fd" target=_blank>https://drive.google.com/drive/folders/1xL5GnXS6XtBlf96UROkW4gAbvsInB-Fd</a>
                </ul>
              </li>
              <li>
                DBSC prototype
                <ul>
                  <li><a href="https://dbsc-prototype-server.glitch.me/" target=_blank>https://dbsc-prototype-server.glitch.me/</a>
                  <li><a href="https://glitch.com/edit/#!/dbsc-prototype-server" target=_blank>https://glitch.com/edit/#!/dbsc-prototype-server</a>
                </ul>
              </li>
            </ul>
          </li>
        </ul>
      </section>
    </article>
  </main>
  <hr>

  <link rel=stylesheet property=stylesheet type=text/css href=https://www.jxck.io/assets/css/footer.css?201223_011131>
  <footer>
    <p class=copyright><small>Copyright &copy; 2016 <a href=https://jxck.io>Jxck</a>. All Rights Reserved.</small> See <small><a href=https://jxck.io/policies/site.html>Site Policy</a> and <a href=https://jxck.io/policies/privacy.html>Privacy Policy</a>.</small></p>
    <!-- Cloudflare Web Analytics --><script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "5a6d3cda77d54761ba2f5c3f56d17ceb"}'></script><!-- End Cloudflare Web Analytics -->
  </footer>

</body>
</html>
