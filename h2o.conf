# to find out the configuration commands, run: h2o --help

# STDERROR: env["rack.errors"].puts(env)

# globa setting
file.send-compressed: ON
file.etag: ON
compress: [ gzip ]
send-server-name: OFF
http2-reprioritize-blocking-assets: ON
pid-file: ./.pid/h2o.pid
error-log: ./logs.jxck.io/error_log
access-log: &logger
  path: "| rotatelogs ./logs.jxck.io/access_log.%Y%m%d 86400"
  # was "%{Save-Data}i\"\t\"%{x-http2-push}o\""
  #format: DateTimeMilli RemoteIP Protocol Status Method Host PathQuery UA Referer ResTime {Headers}
  format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t{\"save-data\":\"%{Save-Data}i\",\"dpr\":\"%{DPR}i\",\"content-dpr\":\"%{Content-DPR}i\",\"width\":\"%{Width}i\",\"viewport-width\":\"%{Viewport-Width}i\",\"range\":\"%{Range}i\",\"origin\":\"%{Origin}i\",\"sec-metadata\":\"%{Sec-Metadata}i\",\"sec-origin-policy\":\"%{Sec-Origin-Policy}i\",\"sec-ch-ua\":\"%{Sec-Ch-UA}i\",\"sec-fetch-dest\":\"%{Sec-Fetch-Dest}i\",\"sec-fetch-mode\":\"%{Sec-Fetch-Mode}i\",\"sec-fetch-site\":\"%{Sec-Fetch-Site}i\",\"sec-fetch-user\":\"%{Sec-Fetch-User}i\",\"accept-encoding\":\"%{Accept-Encoding}i\",\"sec-ch-ua\":\"%{sec-ch-ua}i\",\"sec-ch-ua-arch\":\"%{sec-ch-ua-arch}i\",\"sec-ch-ua-mobile\":\"%{sec-ch-ua-mobile}i\",\"sec-ch-ua-model\":\"%{sec-ch-ua-model}i\",\"sec-ch-ua-platform\":\"%{sec-ch-ua-platform}i\",\"sec-ch-ua-dest\":\"%{sec-ch-ua-dest}i\",\"sec-ch-ua-mode\":\"%{sec-ch-ua-mode}i\",\"sec-ch-ua-site\":\"%{sec-ch-ua-site}i\",\"amp-cache-transform\":\"%{amp-cache-transform}i\"}"
  escape: json

error-doc:
  - status: 404
    url: /assets/img/404.svg
  - status: 500
    url: /assets/img/500.svg
  - status: 501
    url: /assets/img/501.svg

file.mime.addtypes:
  "text/plain; charset=utf-8": ".txt"
  "text/plain; charset=utf-8": ".md"
  "text/plain; charset=utf-8": ".log"
  "text/plain; charset=utf-8": ".sh"
  "text/javascript; charset=utf-8": ".js"
  "text/javascript; charset=utf-8": ".mjs"
  "text/css; charset=utf-8": ".css"
  "application/xml; charset=utf-8": ".xml"
  "application/signed-exchange;v=b3": ".sxg"
  "application/cert-chain+cbor": ".cbor"
  "application/webbundle": ".wbn"
  "application/manifest+json": ".webmanifest"
  "image/avif": ".avif"


file.custom-handler:
  extension: .cgi
  fastcgi.timeout.io: 30000
  fastcgi.timeout.keepalive: 30000
  fastcgi.spawn:
    command: "GEM_PATH=/home/linuxbrew/.linuxbrew/lib/ruby/gems/3.4.0 exec /home/jxck/dotfiles/local/h2o/share/h2o/fastcgi-cgi --pass-authz" # --verbose"


# Proxy List
# https://ws.jxck.io                              => http://127.0.0.1:6000
# https://labs.jxck.io:7000                       => quic-transport (UDP は proxy できない)
# https://labs.jxck.io/trust-token                => http://127.0.0.1:8000
# https://labs.jxck.io/webauthentication/fido-u2f => http://127.0.0.1:9000
# https://blog.jxck.io/amppkg                     => http://127.0.0.1:10000
# https://blog.jxck.io/webpkg                     => http://127.0.0.1:11000
# https://zenn.jxck.io                            => http://127.0.0.1:12000
# https://note.jxck.io                            => http://127.0.0.1:13000

# in path directive
# path:
#   header: 1st
#   mruby:  2nd
#   file:   3rd
hosts:
  "http3.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "http3.jxck.io":
    listen:
      port: 443
      type: quic
      ssl: &ssl
        key-file: /keys/jxck.io/privkey.pem
        certificate-file: /keys/jxck.io/fullchain.pem
        minimum-version: TLSv1.2
        cipher-suite: "TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
        cipher-preference: server
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    header.add: "Cache-Control: no-cache"
    paths: &http3path
      "/":
        mruby.handler: |
          Proc.new do |env|
            [200, {}, ["http3"]]
          end
  "ipv6.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler: |
          Proc.new do |env|
            remote_addr = env["REMOTE_ADDR"]
            [200, {}, ["IPv6\n", "your addr: ", remote_addr, "\n"]]
          end
  "ipv6.jxck.io":
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Cache-Control: no-cache"
    paths:
      "/":
        mruby.handler: |
          Proc.new do |env|
            remote_addr = env["REMOTE_ADDR"]
            server_addr = env["SERVER_ADDR"]
            env["rack.errors"].puts(server_addr)
            unless server_addr == "2001:e42:102:1521:160:16:91:134" then
              [302, {location: "https://ipv4.jxck.io"}, []]
            else
              [200, {}, ["IPv6\n", "your addr: ", remote_addr, "\n"]]
            end
          end
  "ipv4.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler: |
          Proc.new do |env|
            remote_addr = env["REMOTE_ADDR"]
            [200, {}, ["IPv4\n", "your addr: ", remote_addr, "\n"]]
          end
  "ipv4.jxck.io":
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Cache-Control: no-cache"
    paths:
      "/":
        mruby.handler: |
          Proc.new do |env|
            remote_addr = env["REMOTE_ADDR"]
            server_addr = env["SERVER_ADDR"]
            env["rack.errors"].puts(server_addr)
            if server_addr == "2001:e42:102:1521:160:16:91:134" then
              [302, {location: "https://ipv6.jxck.io"}, []]
            else
              [200, {}, ["IPv4\n", "your addr: ", remote_addr, "\n"]]
            end
          end
  "jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "jxck.io":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    # Common
    header.add: "Cache-Control: no-cache"
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "X-Content-Type-Options: nosniff"
    header.add: "Report-To: {\"group\":\"default\", \"include-subdomains\":false, \"max_age\":864000, \"endpoints\":{\"url\":\"https://reporting.jxck.io\"}}"
    #header.add: "Expect-CT: max-age=31536000, report-uri https://reporting.jxck.io;"
    #header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"

    paths:
      "/logo":
        redirect:
          status: 308
          url: https://logo.jxck.io:443/
      "/LLMS.txt":
        file.file: ./www.jxck.io/LLMS.jxck.io.md
      "/":
        header.add: "Content-Security-Policy-Report-Only: default-src 'self' https://*.jxck.io https://*.cloudflareinsights.com; connect-src https://reporting.jxck.io https://cloudflareinsights.com; report-uri https://reporting.jxck.io; report-to default"
        header.add: "Feature-Policy: unsized-media 'none'; sync-xhr 'none'; sync-script 'none'"
        header.add: "NEL: {\"report-to\":\"default\", \"max-age\":864000, \"include-subdomains\":false, \"success-fraction\":0, \"error-fraction\":1.0}"
        header.add: "Accept-CH: DPR, Content-DPR, Width, Viewport-Width, Save-Data, Arch, Model, Platform, Header, Mobile"
        header.add: "Accept-CH-Lifetime: 86400"
        header.add: "Vary: DPR, Content-DPR, Width, Viewport-Width, Save-Data"

        mruby.handler-file: .mruby.handler/robots.rb
        file.dir: ./www.jxck.io

  "www.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "www.jxck.io":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl

    # Common
    #header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/assets/font":
        mruby.handler-file: .mruby.handler/cors.rb # check my origin
        header.set: "Cross-Origin-Resource-Policy: same-origin"
        header.set: "Cache-Control: max-age=2592000"
        header.add: "Cache-Control: immutable"
        #header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        file.dir: ./www.jxck.io/assets/font
      "/assets":
        #header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        # cache busting されてれば無限、そうでなければ no-cache
        mruby.handler: |
          Proc.new do |env|
            headers = {}
            query = env['QUERY_STRING']
            headers["Cache-Control"] = "no-cache" # default
            unless query.empty? # if cache busted
              headers["Cache-Control"] = "max-age=2592000, immutable"
            end
            headers["Access-Control-Allow-Methods"] = "GET, HEAD, OPTIONS"
            headers["Access-Control-Allow-Origin"]  = "*"
            [399, headers, []]
          end
        file.dir: ./www.jxck.io/assets
      "/":
        #header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        redirect:
          status: 308
          url: https://jxck.io:443/
  "blog.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "blog.jxck.io":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    paths:
      # common.h2o.conf
      "/README.md":
        redirect:
          status: 308
          url: https://github.com/Jxck/jxck.io/blob/master/MEMO.md
      "/favicon.ico":
        file.file: ./www.jxck.io/favicon.ico
      "/apple-touch-icon-precomposed.png":
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/apple-touch-icon.png":
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/humans.txt":
        file.file: ./www.jxck.io/humans.txt
      "/security.txt":
        file.file: ./www.jxck.io/security.txt
      "/ads.txt":
        file.file: ./www.jxck.io/ads.txt
      "/LLMS.txt":
        file.file: ./www.jxck.io/LLMS.jxck.io.md
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/manifest.webmanifest":
        header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        header.set: "Cache-Control: no-cache"
        file.file: ./blog.jxck.io/manifest.webmanifest
      # common.h2o.conf
      "/google9ea6e3c69af302c2.html":
        file.file: ./www.jxck.io/assets/google9ea6e3c69af302c2.html
      "/feeds":
        file.dir: ./blog.jxck.io/feeds
      "/tags":
        header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        header.set: "Cache-Control: no-cache"
        # redirect /tags/foo.html => /tags/#foo
        # TODO: FIXME stack level too deep error
        # mruby.handler-file: .mruby.handler/tags.rb
        file.dir: ./blog.jxck.io/tags
      "/assets/js/sw.js":
        # sw for mozaic.fm
        header.add: "Service-Worker-Allowed: /"
        file.file: ./www.jxck.io/assets/js/sw.js
      "/assets/font":
        mruby.handler-file: .mruby.handler/cors.rb # check my origin
        header.set: "Cross-Origin-Resource-Policy: same-origin"
        header.set: "Cache-Control: max-age=2592000"
        header.add: "Cache-Control: immutable"
        file.dir: ./www.jxck.io/assets/font
      "/searches":
        redirect:
          status: 308
          url: /search
      "/search":
        file.file: ./blog.jxck.io/search/search.cgi
      "/drafts":
        mruby.handler-file: .mruby.handler/auth.rb
        file.dirlisting: ON
        file.dir: ./blog.jxck.io/drafts
      "/dictionary":
        header.set: "Content-Type: text/plain"
        header.add: "Use-As-Dictionary: match=\"/entries/*\", expires=600"
        file.dir: ./blog.jxck.io/dictionary

      # "/amppkg":
      #   proxy.reverse.url: "http://127.0.0.1:10000/amppkg"
      # "/webpkg":
      #   proxy.reverse.url: "http://127.0.0.1:11000/webpkg"
      "/":
        # reproxy: ON
        # mruby.handler-file: .mruby.handler/webpkg.rb
        header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        header.set: "Cache-Control: no-cache"
        header.set: "Strict-Transport-Security: max-age=31536000"
        # header.set: "Expect-CT: max-age=31536000, report-uri https://reporting.jxck.io"
        header.set: "X-Content-Type-Options: nosniff"
        header.set: "NEL: {\"report-to\":\"default\", \"max-age\":864000, \"include-subdomains\":false, \"success-fraction\":0, \"error-fraction\":1.0}"
        header.set: "Report-To: {\"group\":\"default\", \"include-subdomains\":false, \"max_age\":864000, \"endpoints\":{\"url\":\"https://reporting.jxck.io\"}}"
        header.set: "Feature-Policy: sync-xhr 'none'"
        header.set: "Accept-CH: DPR, Content-DPR, Width, Viewport-Width, Save-Data, Arch, Model, Platform, Header, Mobile"
        header.set: "Accept-CH-Lifetime: 86400"
        mruby.handler-file: .mruby.handler/robots.rb
        mruby.handler-file: .mruby.handler/index.rb
        mruby.handler-file: .mruby.handler/csp.rb
        file.dir: ./blog.jxck.io
  "slide.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "slide.jxck.io":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Cache-Control: no-cache"
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    header.unset: "Content-Security-Policy-Report-Only"
    paths:
      # common.h2o.conf
      "/favicon.ico":
        file.file: ./www.jxck.io/favicon.ico
      "/apple-touch-icon-precomposed.png":
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/apple-touch-icon.png":
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/humans.txt":
        file.file: ./www.jxck.io/humans.txt
      "/security.txt":
        file.file: ./www.jxck.io/security.txt
      "/ads.txt":
        file.file: ./www.jxck.io/ads.txt
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      # common.h2o.conf
      "/":
        mruby.handler-file: .mruby.handler/robots.rb
        file.dir: ./slide.jxck.io

  "book.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "book.jxck.io":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Cache-Control: no-cache"
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    header.unset: "Content-Security-Policy-Report-Only"
    paths:

      # common.h2o.conf
      "/favicon.ico":
        file.file: ./www.jxck.io/favicon.ico
      "/apple-touch-icon-precomposed.png":
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/apple-touch-icon.png":
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/humans.txt":
        file.file: ./www.jxck.io/humans.txt
      "/security.txt":
        file.file: ./www.jxck.io/security.txt
      "/ads.txt":
        file.file: ./www.jxck.io/ads.txt
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      # common.h2o.conf

      "/":
        mruby.handler-file: .mruby.handler/robots.rb
        file.dir: ./book.jxck.io

  "logo.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "logo.jxck.io":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-cache"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        file.dirlisting: ON
        file.dir: ./www.jxck.io/assets/logo

  "api.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "api.jxck.io:443":
    access-log:
      <<: *logger
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-cache"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/random/worker.js":
        file.file: ./api.jxck.io/random/worker.js
      "/random/number":
        mruby.handler: |
          Proc.new do |env|
            headers = {
              "Content-Type"                 => "text/plain; charset=utf-8",
              "Origin-Trial"                 => "Ai32KiE0NsOIRPR/NxvUwEpcM4hYyo6RPRvkG8liNEIXP4DW6furrliZkqCqZh/ug83oAcdctA12PEh3ymNUZg0AAABneyJvcmlnaW4iOiAiaHR0cHM6Ly9qeGNrLmlvOjQ0MyIsICJpc1N1YmRvbWFpbiI6IHRydWUsICJmZWF0dXJlIjogIkZvcmVpZ25GZXRjaCIsICJleHBpcnkiOiAxNDg0NTgyMTg2fQ==",
              "Link"                         => "</random/worker.js>; rel=\"serviceworker\"",
              "Access-Control-Allow-Methods" => "GET, HEAD, OPTIONS",
              "Access-Control-Allow-Origin"  => "*"
            }
            body = [
              rand(100)
            ]
            [200, headers, body]
          end
      "/random":
        header.add: "Access-Control-Allow-Origin: *"
        mruby.handler-file: .mruby.handler/random.rb
      # "/translate":
        # file.file: ./api.jxck.io/translate/server.cgi
      "/sleep":
        mruby.handler: |
          Proc.new do |env|
            headers = {
              "Content-Type"                 => "application/json; charset=utf-8",
              "Access-Control-Allow-Methods" => "GET",
              "Access-Control-Allow-Origin"  => "*"
            }
            q = env["QUERY_STRING"].to_i || 0
            sleep(q)
            n = rand(100)
            body = [
              <<-EOS
                { "n": #{n} }
              EOS
            ]
            [200, headers, body]
          end

  "files.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "files.jxck.io:443":
    access-log:
      <<: *logger
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-cache"
    header.add: "Referrer-Policy: no-referrer"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/dos.rb
        mruby.handler-file: .mruby.handler/auth.rb
        file.dirlisting: ON
        file.dir: ./files.jxck.io

  "admin.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "admin.jxck.io:443":
    access-log:
      <<: *logger
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-store"
    header.add: "Referrer-Policy: no-referrer"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/auth.rb
        file.dir: ./admin.jxck.io
      "/log.cgi":
        mruby.handler-file: .mruby.handler/auth.rb
        file.file: ./logs.jxck.io/log.cgi
      "/logout":
        mruby.handler: |
          Proc.new do |env|
            headers = {}
            headers["Content-Type"] = "text/plain"
            headers["Clear-Site-Data"] = '"*"'
            [401, headers, ["logout"]]
          end

  "ws.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "ws.jxck.io:443":
    access-log:
      <<: *logger
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-cache"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        proxy.tunnel: ON
        proxy.reverse.url: "http://127.0.0.1:6000/"

  "reporting.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "reporting.jxck.io:443":
    access-log:
      <<: *logger
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-cache"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/beacon":
        # JS から sendBeacon する
        file.file: ./reporting.jxck.io/beacon/reporting.cgi
      "/labs":
        # labs で指定する
        file.file: ./reporting.jxck.io/labs/reporting.cgi
      "/":
        # Report-To に指定する
        file.file: ./reporting.jxck.io/reporting.cgi

  "zenn.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "zenn.jxck.io:443":
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Cache-Control: no-cache"
    header.add: "Referrer-Policy: no-referrer"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        mruby.handler: |
          require "htpasswd.rb"
          Htpasswd.new("/keys/.htpasswd.zenn", "zenn-guest")
        proxy.tunnel: ON
        proxy.reverse.url: "http://127.0.0.1:12000/"

  "note.jxck.io:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        proxy.tunnel: ON
        proxy.reverse.url: "http://127.0.0.1:14000/"
  "note.jxck.io:443":
    listen:
      port: 443
      ssl:
        <<: *ssl
    header.add: "Strict-Transport-Security: max-age=31536000"
    header.add: "Referrer-Policy: no-referrer"
    header.add: "Cache-Control: no-cache"
    paths:
      "/.well-known":
        file.dir: ./www.jxck.io/.well-known
      "/":
        # mruby.handler: |
        #   require "htpasswd.rb"
        #   Htpasswd.new("/keys/.htpasswd.zenn", "zenn-guest")
        proxy.tunnel: ON
        proxy.reverse.url: "http://127.0.0.1:14000/"

  "labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    file.dirlisting: ON
    listen:
      port: 443
      type: quic
      ssl: &ssl
        key-file: /keys/jxck.io/privkey.pem
        certificate-file: /keys/jxck.io/fullchain.pem
        minimum-version: TLSv1.2
        cipher-suite: "TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384"
        cipher-preference: server
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths: &labs-path
      "/tmp":
        mruby.handler: |
          Proc.new do |env|
            env["rack.errors"].puts(env)
            if env["HTTP_USER_AGENT"].match?(/hatena/i)
              if env["PATH_INFO"] == "/10.html"
                next [308, {
                  "Location": "https://labs.jxck.io/tmp/09.html",
                  "Link": 'https://labs.jxck.io/tmp/09.html; rel="canonical"'
                }, []]
              end
              html = <<-EOS
                <!DOCTYPE html>
                <html lang=ja>
                <head>
                  <meta charset=utf-8>
                  <title>mruby 09 title</title>
                  <link rel=canonical href=https://labs.jxck.io/tmp/09.html>
                </head>
                <body>
                  <h1>mruby 09 h1</h1>
                </body>
                </html>
              EOS

              headers = {}
              headers["content-type"] = "text/html"
              headers["content-length"] = html.size
              next [200, headers, [html]]
            end
            next [399, {}, []]
          end
        file.dir: ./labs.jxck.io/tmp

      # common.h2o.conf
      "/favicon.ico":
        header.unset: "Content-Security-Policy-Report-Only"
        file.file: ./www.jxck.io/favicon.ico
      "/apple-touch-icon-precomposed.png":
        header.unset: "Content-Security-Policy-Report-Only"
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/apple-touch-icon.png":
        header.unset: "Content-Security-Policy-Report-Only"
        file.file: ./www.jxck.io/assets/img/jxck.png
      "/humans.txt":
        header.unset: "Content-Security-Policy-Report-Only"
        file.file: ./www.jxck.io/humans.txt
      "/security.txt":
        header.unset: "Content-Security-Policy-Report-Only"
        file.file: ./www.jxck.io/security.txt
      "/ads.txt":
        header.unset: "Content-Security-Policy-Report-Only"
        file.file: ./www.jxck.io/ads.txt
      "/.well-known":
        header.unset: "Content-Security-Policy-Report-Only"
        file.dir: ./www.jxck.io/.well-known
      # common.h2o.conf

      "/":
        mruby.handler-file: .mruby.handler/logger.rb
        mruby.handler-file: .mruby.handler/robots.rb
        header.add: 'Report-To: { "url": "https://reporting.jxck.io/labs", "group": "labs", "max-age": 10886400 }'
        file.dir: ./labs.jxck.io
      "/assets":
        file.dir: ./labs.jxck.io/assets
      "/mixed":
        mruby.handler: |
          Proc.new do |env|
            headers = {}
            env.each {|k, v|
              if k.start_with?("HTTP_")
                headers[k[5..-1].downcase] = v
              end
            }
            case env["QUERY_STRING"]
            when "upgrade-insecure-request"
              headers["Content-Security-Policy"] = "upgrade-insecure-requests"
            when "block-all-mixed-content"
              headers["Content-Security-Policy"] = "block-all-mixed-content; report-uri https://reporting.jxck.io/labs"
            end
            [399, headers, []]
          end
        file.dir: ./labs.jxck.io/mixed
      "/strict-transport-security":
        header.add: "Strict-Transport-Security: max-age=31536000"
        header.add: "Cache-Control: no-store"
        file.dir: ./labs.jxck.io/strict-transport-security
      "/service-worker/link-rel-service-worker":
        mruby.handler: |
          Proc.new do |env|
            if /\/random\z/.match(env["PATH_INFO"])
              headers = {
                "Content-Type" => "text/plain; charset=utf-8",
                "Link" => "</service-worker/link-rel-service-worker/random.js>; rel=\"serviceworker\"",
                "Origin-Trial" => "Ai32KiE0NsOIRPR/NxvUwEpcM4hYyo6RPRvkG8liNEIXP4DW6furrliZkqCqZh/ug83oAcdctA12PEh3ymNUZg0AAABneyJvcmlnaW4iOiAiaHR0cHM6Ly9qeGNrLmlvOjQ0MyIsICJpc1N1YmRvbWFpbiI6IHRydWUsICJmZWF0dXJlIjogIkZvcmVpZ25GZXRjaCIsICJleHBpcnkiOiAxNDg0NTgyMTg2fQ=="
              }
              body = [
                rand(100)
              ]
              [200, headers, body]
            else
              [399, {}, []]
            end
          end
        file.dir: ./labs.jxck.io/service-worker/link-rel-service-worker
      "/service-worker/foreign-fetch":
        header.set: "Origin-Trial: Ai32KiE0NsOIRPR/NxvUwEpcM4hYyo6RPRvkG8liNEIXP4DW6furrliZkqCqZh/ug83oAcdctA12PEh3ymNUZg0AAABneyJvcmlnaW4iOiAiaHR0cHM6Ly9qeGNrLmlvOjQ0MyIsICJpc1N1YmRvbWFpbiI6IHRydWUsICJmZWF0dXJlIjogIkZvcmVpZ25GZXRjaCIsICJleHBpcnkiOiAxNDg0NTgyMTg2fQ=="
        file.dir: ./labs.jxck.io/service-worker/foreign-fetch

      "/service-worker/cache-expire":
        header.set: "Cache-Control: max-age=5"
        file.dir: ./labs.jxck.io/service-worker/cache-expire

      "/service-worker/navigation-preload/tmp.js":
        mruby.handler: |
          Proc.new do |env|
            headers = {
              "Content-Type" => "text/javascript; charset=utf-8",
              "Cache-Control" => "max-age=10",
            }
            body = File.read("./labs.jxck.io/service-worker/navigation-preload/tmp.js")
            sleep(3)
            [200, headers, [body]]
          end

      "/service-worker/cache-pattern/stale-while-revalidate/test.json":
        mruby.handler: |
          Proc.new do |env|
            headers = {
              "Content-Type" => "text/json; charset=utf-8"
            }
            body = [
              '{ "version": 3 }'
            ]
            sleep(3)
            [200, headers, body]
          end
      #"/service-worker/basic/mozaic-ep61.mp3":
      #  access-log:
      #    path: ./labs.jxck.io/service-worker/basic/access.log
      #    format: "%m %s %U %q Range:%{Range}i Content-Range:%{Content-Range}o"
      #  file.file: ./labs.jxck.io/service-worker/basic/mozaic-ep61.mp3

      "/stale-while-revalidate/random":
        header.add: "Cache-Control: max-age=5, stale-while-revalidate=10, stale-if-error=15"
        mruby.handler-file: .mruby.handler/random.rb
        file.dir: ./labs.jxck.io/stale-while-revalidate

      "/content-security-policy":
        header.add: "Content-Security-Policy: default-src 'self'; report-uri https://reporting.jxck.io/labs"
        file.dir: ./labs.jxck.io/content-security-policy
      "/content-security-policy/sandbox.html":
        header.add: "Content-Security-Policy: sandbox" # no reporting
        file.file: ./labs.jxck.io/content-security-policy/sandbox.html
      "/content-security-policy/navigate-to.html":
        header.add: "Content-Security-Policy: navigate-to none; report-uri https://reporting.jxck.io/labs"
        file.file: ./labs.jxck.io/content-security-policy/navigate-to.html

      "/subresource-integrity/main.css":
        file.file: ./labs.jxck.io/subresource-integrity/main.css
        header.add: "Access-Control-Allow-Origin: *"
      "/subresource-integrity/main.js":
        file.file: ./labs.jxck.io/subresource-integrity/main.js
        header.add: "Access-Control-Allow-Origin: *"
      "/subresource-integrity/main.txt":
        file.file: ./labs.jxck.io/subresource-integrity/main.txt
        header.add: "Access-Control-Allow-Origin: *"

      "/public-key-pinning":
        header.add: "Cache-Control: no-store"
        header.add: "Public-Key-Pins: max-age=3600; pin-sha256=\"7JT7NhX2St/VBBkRi4BO427M7ytLy7p3CRYPtHpSm7c=\"; pin-sha256=\"+WpRHNpAId2FIOvVgwmS3HsG+eJtERKC4/qM1tQaeRk=\"; report-uri https://reporting.jxck.io/labs; report-to labs;"
        header.add: 'Report-To: { "url": "https://reporting.jxck.io/labs", "group": "labs", "max-age": 10886400 }'
        file.dir: ./labs.jxck.io/public-key-pinning
      "/expect-ct":
        header.add: "Expect-CT: max-age=100, enforce, test-report, report-uri https://reporting.jxck.io/labs; report-to labs;"
        header.add: 'Report-To: { "url": "https://reporting.jxck.io/labs", "group": "labs", "max-age": 10886400 }'
        file.dir: ./labs.jxck.io/expect-ct
      "/trusted-types/default-policy.html":
        header.add: "Content-Security-Policy: require-trusted-types-for 'script'"
        file.file: ./labs.jxck.io/trusted-types/default-policy.html
      "/trusted-types/policy.html":
        header.add: "Content-Security-Policy: require-trusted-types-for 'script'; trusted-types demo"
        file.file: ./labs.jxck.io/trusted-types/policy.html
      "/cache-control-immutable/large.immutable.bmp":
        header.add: "Cache-Control: max-age=60, immutable"
        file.file: ./labs.jxck.io/cache-control-immutable/large.immutable.bmp
      "/etag/style.css":
        # header.add: "Cross-Origin-Opener-Policy: same-origin"
        # header.add: "Cross-Origin-Resource-Policy: same-origin"
        # header.add: "Referrer-Policy: same-origin"
        header.add: "Cache-Control: public, max-age=31536000, immutable"
        header.add: "Content-Type: text/css; charset=UTF-8"
        header.add: "Cross-Origin-Opener-Policy: same-origin"
        header.add: 'ETag: W/"0-1955b607150"'
        header.add: "Server-Timing: c_e;dur=36"
        header.add: "x-served-by: cache-nrt-rjtf7700101-NRT"
        header.add: "x-test-header: v4444444444444444444"
        file.file: ./labs.jxck.io/etag/style.css
      "/etag/script.js":
        header.add: "Cache-Control: public, max-age=31536000, immutable"
        header.add: "Content-Type: application/javascript; charset=UTF-8"
        header.add: "Cross-Origin-Opener-Policy: same-origin"
        header.add: 'ETag: W/"5b0-1955b607150"'
        header.add: "Server-Timing: c_e;dur=5"
        header.add: "x-served-by: cache-nrt-rjtf7700098-NRT"
        header.add: "x-test-header: v4444444444444444444"
        file.file: ./labs.jxck.io/etag/script.js
      "/etag":
        # header.add: "ETag: \"deadbeef\""
        # header.add: "ETag: W/\"facefeed\""
        # file.dir: ./labs.jxck.io/etag
        mruby.handler: |
          Proc.new do |env|
            # logger = env["rack.errors"]
            etag =  '"deadbeef"'
            headers = {
              "ETag": etag,
              "Cache-Control": "no-cache",
              "Cross-Origin-Opener-Policy": "same-origin",
              "Server-Timing": "c_e;dur=52"
            }
            if (env["HTTP_IF_NONE_MATCH"] == etag) then
              [304, headers, []]
            else
              html = <<-EOS
              <!DOCTYPE html>
              <meta charset=utf-8>
              <title>ETag Demo</title>
              <link rel="stylesheet" href=/etag/style.css>
              <script src=/etag/script.js></script>
              <h1>ETag Demo</h1>
              <p>random: #{rand(100000)}</p>
              <p><a href="etag">reload</a></p>
              EOS
              [200, headers, [html]]
            end
          end
      "/http2/push":
        mruby.handler-file: .mruby.handler/push.rb
        file.dir: ./labs.jxck.io/http2/push
      "/client-hints/basic.html":
        header.add: "Accept-CH: viewport-width, width, device-memory, dpr, rtt, downlink, save-data"
        header.add: "Accept-CH-Lifetime: 86400"
        file.file: ./labs.jxck.io/client-hints/basic.html
      "/iframe/iframe-options/x-frame-options.html":
        header.add: "X-Frame-Options: deny"
        file.file: ./labs.jxck.io/iframe/iframe-options/x-frame-options.html
      "/iframe/fencedframe":
        header.add: "Supports-Loading-Mode: fenced-frame"
        file.dir: ./labs.jxck.io/iframe/fencedframe
      "/iframe/style":
        header.add: "Supports-Loading-Mode: fenced-frame"
        file.dir: ./labs.jxck.io/iframe/style
      "/feature-policy/sync-xhr/basic.html":
        header.add: "Feature-Policy: sync-xhr 'none'"
        file.file: ./labs.jxck.io/feature-policy/sync-xhr/basic.html
      "/feature-policy/sync-xhr/sandbox.html":
        header.add: "Content-Security-Policy: sandbox allow-scripts"
        header.add: "Feature-Policy: sync-xhr 'none'"
        file.file: ./labs.jxck.io/feature-policy/sync-xhr/sandbox.html
      "/feature-policy/geolocation/basic.html":
        header.add: "Feature-Policy: geolocation https://lab2.jxck.io"
        file.file: ./labs.jxck.io/feature-policy/geolocation/basic.html
      "/feature-policy/geolocation/sandbox.html":
        #header.add: "Content-Security-Policy: sandbox allow-scripts;"
        #header.add: "Feature-Policy: geolocation https://lab2.jxck.io;"
        file.file: ./labs.jxck.io/feature-policy/geolocation/sandbox.html
      "/feature-policy/unsized-media/basic.html":
        header.add: "Feature-Policy: unsized-media 'none'"
        file.file: ./labs.jxck.io/feature-policy/unsized-media/basic.html
      "/webauthentication/fido-u2f/":
        proxy.reverse.url: "http://127.0.0.1:9000/"

      "/webpackaging/signed-http-exchange-b2/mozaic.sxg":
        header.add: "Origin-Trial: AqRrdT6xs8ajyoWFIsg3pmFbJ0qHOFo9eWA+agUU1NMmNOGoSo9KRPKDi6TjuTSRVYZkPzc34ZLPQRw9PhyFxwUAAABxeyJvcmlnaW4iOiJodHRwczovL2p4Y2suaW86NDQzIiwiZmVhdHVyZSI6IlNpZ25lZEhUVFBFeGNoYW5nZU9yaWdpblRyaWFsIiwiZXhwaXJ5IjoxNTQ2MjcxMDI4LCJpc1N1YmRvbWFpbiI6dHJ1ZX0="
        file.file: ./labs.jxck.io/webpackaging/signed-http-exchange-b2/mozaic.sxg

      "/webpackaging/signed-http-exchange-b3/test.sxg":
        header.add: "X-Content-Type-Options: nosniff"
        file.file: ./labs.jxck.io/webpackaging/signed-http-exchange-b3/test.sxg

      "/webpackaging/subresource-webbundle/profile-card.wbn":
        header.add: "Cache-Control: no-store"
        file.file: ./labs.jxck.io/webpackaging/subresource-webbundle/profile-card.wbn

      "/webpackaging/subresource-webbundle/bundle-link-header.html":
        header.add: 'Link: <https://labs.jxck.io/webpackaging/subresource-webbundle/bundle.wbn>; rel="webbundle"; resources="https://labs.jxck.io/webpackaging/subresource-webbundle/a.js https://labs.jxck.io/webpackaging/subresource-webbundle/b.js https://labs.jxck.io/webpackaging/subresource-webbundle/c.css https://labs.jxck.io/webpackaging/subresource-webbundle/d.css https://labs.jxck.io/webpackaging/subresource-webbundle/e.png https://labs.jxck.io/webpackaging/subresource-webbundle/favicon.ico"'
        file.file: ./labs.jxck.io/webpackaging/subresource-webbundle/bundle-link-header.html

      "/isInputPending":
        header.add: "Origin-Trial: Am+ipb+vzD4tjqTIaJfssfnhwAdaV9c4u9NX6PO/5CRUel6ALwnmN5vyk/DA+TSbqE5FprWcHY+j9vDxh/hqNA8AAABueyJvcmlnaW4iOiJodHRwczovL2p4Y2suaW86NDQzIiwiZmVhdHVyZSI6IkV4cGVyaW1lbnRhbElzSW5wdXRQZW5kaW5nIiwiZXhwaXJ5IjoxNTY3NTU1MTk5LCJpc1N1YmRvbWFpbiI6dHJ1ZX0="
        file.dir: ./labs.jxck.io/isInputPending

      "/picture/sizes":
        header.add: "Cache-Control: no-store"
        file.dir: ./labs.jxck.io/picture/sizes

      "/cache-control/plain.html":
        header.unset: "Cache-Control"
        header.unset: "Last-Modified"
        file.file: ./labs.jxck.io/cache-control/plain.html
      "/cache-control/no-cache.html":
        header.unset: "Cache-Control"
        header.unset: "Last-Modified"
        header.add: "Cache-Control: no-cache"
        file.file: ./labs.jxck.io/cache-control/no-cache.html
      "/cache-control/no-store.html":
        header.unset: "Cache-Control"
        #header.unset: "Last-Modified"
        header.add: "Cache-Control: no-store"
        #file.file: ./labs.jxck.io/cache-control/no-store.html
        mruby.handler: |
          Proc.new do |env|
            headers = {}
            headers["Content-Type"] = "text/html"
            headers["Cache-Control"] = "no-store"
            headers["Last-Modified"] = "Thu, 02 Dec 2021 00:00:00 GMT"
            html = <<-EOS
            <!DOCTYPE html>
            <meta charset=utf-8>
            <title>Cache-Control: no-store DEMO</title>
            <h1>Cache-Control: no-store DEMO</h1>
            <p>random: #{rand(100000)}</p>
            <p><a href="no-store.html">reload</a></p>
            EOS
            [200, headers, [html]]
          end


      "/cache-control/max-age=0.html":
        header.unset: "Cache-Control"
        header.unset: "Last-Modified"
        header.add: "Cache-Control: max-age=0"
        file.file: ./labs.jxck.io/cache-control/max-age=0.html
      "/cache-control/max-age=10.html":
        header.unset: "Cache-Control"
        header.unset: "Last-Modified"
        header.add: "Cache-Control: max-age=10"
        file.file: ./labs.jxck.io/cache-control/max-age=10.html
      "/cache-control/must-revalidate.html":
        header.unset: "Cache-Control"
        header.unset: "Last-Modified"
        header.add: "Cache-Control: must-revalidate, max-age=10"
        file.file: ./labs.jxck.io/cache-control/must-revalidate.html
      "/cache-control/must-understand.html":
        header.unset: "Cache-Control"
        header.unset: "Last-Modified"
        header.add: "Cache-Control: max-age=60, must-understand, no-store"
        file.file: ./labs.jxck.io/cache-control/must-understand.html

      "/fetch/api":
        mruby.handler: |
          Proc.new do |env|
            logger = env["rack.errors"]

            status = 200
            headers = {}
            body = ""

            if (env["REQUEST_METHOD"] == "GET") then
              headers = {
                "Access-Control-Allow-Origin"=> env["HTTP_ORIGIN"],
                "Vary" => "origin"
              }
            elsif (["POST", "PUT", "DELETE"].include?(env["REQUEST_METHOD"])) then
              status = 201
              headers = {
                "Access-Control-Allow-Origin"=> env["HTTP_ORIGIN"],
                "Vary" => "origin"
              }
              body = "done"
            elsif (env["REQUEST_METHOD"] == "OPTIONS") then
              logger.p("preflight")
              headers = {
                "Access-Control-Allow-Origin"=> env["HTTP_ORIGIN"],
                "Access-Control-Allow-Methods" => "POST",
                "Access-Control-Allow-Headers" => "Content-Type",
                "Access-Control-Max-Age" => 5
              }
              body = "preflight success"
            else
              status = 405
              body = "expect DELETE method"
            end
            [status, headers, [body]]
          end

      "/clear-site-data/basic.html":
        header.add: "Set-Cookie: cookiefromserver=valueeeeeeeeeeeee; Secure; HttpOnly"
        file.file: ./labs.jxck.io/clear-site-data/basic.html
      "/clear-site-data/executionContexts":
        mruby.handler: |
          Proc.new do |env|
            headers = {}
            headers["Content-Type"] = "text/html"
            headers["Clear-Site-Data"] = %("executionContexts")
            html = <<-EOS
            <!DOCTYPE html>
            <meta charset=utf-8>
            <title>clear executionContexts</title>
            <h1>clear executionContexts</h1>
            EOS
            [200, headers, [html]]
          end
      "/clear-site-data/clear":
        mruby.handler: |
          Proc.new do |env|
            headers = {}
            q = env["QUERY_STRING"]
            q = "*" if q == "all"
            headers["Clear-Site-Data"] = %("#{q}")
            headers["Content-Type"] = "text/html"
            html = <<-EOS
            <!DOCTYPE html>
            <meta charset=utf-8>
            <title>clear #{q}</title>
            <h1>clear #{q}</h1>
            EOS
            [200, headers, [html]]
          end
      "/same-site-cookie/basic.html":
        mruby.handler: |
          Proc.new do |env|
            url = env["HTTP_HOST"]
            headers = {}
            SameSiteCookie = "none=samesite; SameSite=None; Secure"
            headers["Set-Cookie"] = SameSiteCookie if url == "labs.jxck.io"
            [399, headers, []]
          end
        file.file: ./labs.jxck.io/same-site-cookie/basic.html
      "/same-site-cookie/samesite-lax.html":
        header.add: "Set-Cookie: lax=samesite; SameSite=Lax; Secure"
        file.file: ./labs.jxck.io/same-site-cookie/samesite-lax.html
      "/same-site-cookie/samesite-strict.html":
        header.add: "Set-Cookie: strict=samesite; SameSite=Strict; Secure"
        file.file: ./labs.jxck.io/same-site-cookie/samesite-strict.html
      "/same-site-cookie/samesite-none.html":
        header.add: "Set-Cookie: none=samesite; SameSite=None; Secure"
        file.file: ./labs.jxck.io/same-site-cookie/samesite-none.html
      "/same-site-cookie/post":
        mruby.handler: |
          Proc.new do |env|
            method = env["REQUEST_METHOD"]
            cookie = env["HTTP_COOKIE"]
            origin = env["HTTP_ORIGIN"]
            body   = env["rack.input"] ? env["rack.input"].read : ""

            html = <<-EOS
              <!DOCTYPE html>
              <meta charset=utf-8>
              <title>csrf response</title>
              <dl>
                <dt>method:</dt><dd>#{method}</dd>
                <dt>cookie:</dt><dd>#{cookie}</dd>
                <dt>origin:</dt><dd>#{origin}</dd>
                <dt>body:</dt><dd>#{body}</dd>
              </dl>
            EOS
            [200, {}, [html]]
          end
      "/permission-policy/potential-violation":
        mruby.handler: |
          Proc.new do |env|
            query = env["QUERY_STRING"]
            policy = case query
              when "a"
                "ch-ua-arch=(self)"
              when "b"
                'ch-ua-arch=(self "https://*.mozaic.fm")'
              else
                ""
            end
            header = {
              "Accept-CH": "Sec-CH-UA-Arch",
              "Permissions-Policy": policy
            }
            body = <<-EOS
              <!DOCTYPE html>
              <meta charset=utf-8>
              <title>Permission Policy Potential Violation DEMO</title>
              <h1>Permission Policy Potential Violation DEMO</h1>
              <ul>
                <li><a href="./potential-violation?a">ch-ua-arch=(self)</a></li>
                <li><a href="./potential-violation?b">ch-ua-arch=(self "https://*.mozaic.fm")</a></li>
              </ul>
              <iframe allow="geolocation" src="https://labs.mozaic.fm/permission-policy/iframe.html"></iframe>
            EOS
            [200, header, [body]]
          end
      "/permission-policy/ch-ua.html":
        header.add: 'Accept-CH: Sec-CH-UA-Arch'
        file.file: ./labs.jxck.io/permission-policy/ch-ua.html
      "/vary/random.json":
        mruby.handler: |
          Proc.new do |env|
            lang   = env["HTTP_ACCEPT_LANGUAGE"]
            body   = "#{lang}, #{rand(10)}"
            header = {
              "Cache-Control": "max-age=10",
              "Vary":          "Accept-Language",
            }
            [200, header, [body]]
          end

      "/referrer-policy/header.html":
        header.add: "Referrer-Policy: same-origin"
        file.file: ./labs.jxck.io/referrer-policy/header.html

      "/cookie/basic.html":
        header.add: "Set-Cookie: server-plain=server; Path=/"
        header.add: "Set-Cookie: server-secure=server; Secure; Path=/"
        header.add: "Set-Cookie: server-httponly=server; HttpOnly; Path=/"
        file.file: ./labs.jxck.io/cookie/basic.html
      "/cookie/remove.html":
        mruby.handler: |
          Proc.new do |env|
            cookie = env["HTTP_COOKIE"]
                      .split(";")
                      .map{|e| e.split("=").first.strip()}
                      .map{|e| ["Set-Cookie", "#{e}=0; Max-Age=0"]}
            header = [
              ["Location", "basic.html"],
              *cookie
            ]
            [302, header, []]
          end

      "/scroll-to-text-fragment/":
        header.add: "Origin-Trial: AuFg/AO/8BYfj27nL1e7b0lN/R66S/E8HFkdqHc4LQLRDI5q+ewQsdOxCgLgyHUN7aV1vuPjb8MM6zXV+wQQYA0AAABreyJvcmlnaW4iOiJodHRwczovL2p4Y2suaW86NDQzIiwiZmVhdHVyZSI6IlRleHRGcmFnbWVudElkZW50aWZpZXJzIiwiZXhwaXJ5IjoxNTc0NzQxNTA2LCJpc1N1YmRvbWFpbiI6dHJ1ZX0="
        file.dir: ./labs.jxck.io/scroll-to-text-fragment

      # site-isolation: cross-origin-resouce-policy
      "/site-isolation/cross-origin-resource-policy/same-site.js":
        header.add: 'Cross-Origin-Resource-Policy: same-site'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-resource-policy/same-site.js
      "/site-isolation/cross-origin-resource-policy/same-origin.js":
        header.add: 'Cross-Origin-Resource-Policy: same-origin'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-resource-policy/same-origin.js

      # site-isolation: cross-origin-embedder-policy
      "/site-isolation/cross-origin-embedder-policy/index.html":
        header.add: 'Cross-Origin-Embedder-Policy: require-corp'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/index.html

      "/site-isolation/cross-origin-embedder-policy/corp-none.html":
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/corp-none.html
      "/site-isolation/cross-origin-embedder-policy/corp-same-site.html":
        header.add: 'Cross-Origin-Embedder-Policy: require-corp'
        header.add: 'Cross-Origin-Resource-Policy: same-site'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/corp-same-site.html
      "/site-isolation/cross-origin-embedder-policy/corp-same-origin.html":
        header.add: 'Cross-Origin-Embedder-Policy: require-corp'
        header.add: 'Cross-Origin-Resource-Policy: same-origin'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/corp-same-origin.html
      "/site-isolation/cross-origin-embedder-policy/corp-cross-origin.html":
        header.add: 'Cross-Origin-Embedder-Policy: require-corp'
        header.add: 'Cross-Origin-Resource-Policy: cross-origin'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/corp-cross-origin.html

      "/site-isolation/cross-origin-embedder-policy/cors-none.js":
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/cors-none.js
      "/site-isolation/cross-origin-embedder-policy/cors-acao.js":
        header.add: 'Access-Control-Allow-Origin: https://labs.jxck.io'
        file.file: ./labs.jxck.io/site-isolation/cross-origin-embedder-policy/cors-acao.js

      # site-isolation: cross-origin-embedder-policy
      "/site-isolation/cross-origin-opener-policy/index.html":
        mruby.handler: |
          Proc.new do |env|
            q = env["QUERY_STRING"]
            coop = case q
                   when 'coop=same-origin' then
                     'same-origin'
                   when 'coop=same-origin-allow-popups' then
                     'same-origin-allow-popups'
                   when 'coop=unsafe-none' then
                     'unsafe-none'
                   end
            headers = {'Cross-Origin-Opener-Policy': coop}
            [399, headers, []]
          end
        file.file: ./labs.jxck.io/site-isolation/cross-origin-opener-policy/index.html

      "/site-isolation/crossOriginIsolated/favicon.ico":
        header.add: 'Cross-Origin-Embedder-Policy: require-corp'
        header.add: 'Cross-Origin-Resource-Policy: same-origin'
        header.add: 'Cross-Origin-Opener-Policy: same-origin'
        file.file: ./labs.jxck.io/site-isolation/crossOriginIsolated/favicon.ico
      "/site-isolation/crossOriginIsolated":
        header.add: 'Cross-Origin-Embedder-Policy: require-corp'
        header.add: 'Cross-Origin-Resource-Policy: same-origin'
        header.add: 'Cross-Origin-Opener-Policy: same-origin'
        file.file: ./labs.jxck.io/site-isolation/crossOriginIsolated/index.html

      # origin-isolation
      "/site-isolation/origin-isolation/index.html":
        header.add: 'Origin-Isolation: ?1'
        header.add: 'Origin-Trial: Aom93DApjd9DRckord07pomvk5IRICetY65EL78Y2Una5zOa3BLBZdmimyoIQXqttKpWzbgISCgROTzUKMVp8gQAAABpeyJvcmlnaW4iOiJodHRwczovL2p4Y2suaW86NDQzIiwiZmVhdHVyZSI6Ik9yaWdpbklzb2xhdGlvbkhlYWRlciIsImV4cGlyeSI6MTU5Mzg2ODA5OCwiaXNTdWJkb21haW4iOnRydWV9'
        file.file: ./labs.jxck.io/site-isolation/origin-isolation/index.html


      "/crossorigin/a.js":
        header.add: 'Access-Control-Allow-Origin: https://lab2.jxck.io'
        file.file: ./labs.jxck.io/crossorigin/a.js

      "/crossorigin/a.png":
        header.add: 'Access-Control-Allow-Origin: https://lab2.jxck.io'
        file.file: ./labs.jxck.io/crossorigin/a.png

      "/fledge":
        header.add: 'X-Allow-FLEDGE: true'
        header.add: 'Access-Control-Allow-Origin: *'
        file.dir: ./labs.jxck.io/fledge

      "/resource-hints/prefetch.html":
        header.add: 'Set-Cookie: id=prefetch'
        file.file: ./labs.jxck.io/resource-hints/prefetch.html
      "/resource-hints/prerender.html":
        header.add: 'Set-Cookie: id=prerender'
        file.file: ./labs.jxck.io/resource-hints/prerender.html
      "/resource-hints/preload.html":
        header.add: 'Set-Cookie: id=preload'
        file.file: ./labs.jxck.io/resource-hints/preload.html
      "/resource-hints/preload.css":
        mruby.handler: |
          Proc.new do |env|
            body   = <<-EOS
              div {
                background-image: url('../assets/jxck.png');
                background-size: cover;
                width: 128px;
                height: 128px;
              }
            EOS
            header = {
              "content-type": "text/css",
              "cache-control": "no-cache",
            }
            sleep(2)
            [200, header, [body]]
          end
        file.file: ./labs.jxck.io/resource-hints/preload.css
      "/navigation/login":
        mruby.handler: |
          Proc.new do |env|
            headers = {
              "location": "/navigation/main.html"
            }
            [302, headers, []]
          end
      "/device-bound-session-credentials/index.html":
        header.add: 'Cache-Control: no-cache'
        file.file: ./labs.jxck.io/device-bound-session-credentials/index.html
      "/device-bound-session-credentials/test.html":
        header.add: 'Cache-Control: no-cache'
        file.file: ./labs.jxck.io/device-bound-session-credentials/test.html
      "/device-bound-session-credentials/login":
        file.file: ./labs.jxck.io/device-bound-session-credentials/session.cgi
      "/device-bound-session-credentials/session":
        file.file: ./labs.jxck.io/device-bound-session-credentials/session.cgi
      "/device-bound-session-credentials/refresh":
        file.file: ./labs.jxck.io/device-bound-session-credentials/session.cgi
      "/device-bound-session-credentials/":
          mruby.handler: |
            Proc.new do |env|
              headers = {
                "location": "/device-bound-session-credentials/index.html"
              }
              [302, headers, []]
            end
      "/.well-known/trust-token/key-commitment":
        proxy.reverse.url: "http://127.0.0.1:8000/.well-known/trust-token/key-commitment"
      "/.well-known/trust-token/request":
        proxy.reverse.url: "http://127.0.0.1:8000/.well-known/trust-token/request"
      "/.well-known/trust-token/redemption":
        proxy.reverse.url: "http://127.0.0.1:8000/.well-known/trust-token/redemption"
      "/.well-known/trust-token/send-srr":
        proxy.reverse.url: "http://127.0.0.1:8000/.well-known/trust-token/send-srr"

      "/.well-known/trust-token":
        file.file: ./labs.jxck.io/trust-token/trust_token.cgi

      "/.well-known/register-conversion":
        file.file: ./labs.jxck.io/conversion-measurement/register-conversion.cgi

      "/.well-known/attribution-reporting/report-attribution":
        file.file: ./labs.jxck.io/attribution-reporting/register-attribution.cgi

  "lab2.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    http2-casper: ON
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "publisher.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "advertiser.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "adtech.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "shopping.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "travel.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "ssp.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  "dsp.labs.jxck.io":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    file.etag: OFF
    listen:
      port: 443
      ssl:
        <<: *ssl
    listen:
      port: 80
    paths:
      <<: *labs-path

  ### mozaic.fm
  "mozaic.fm:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./mozaic.fm/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "mozaic.fm":
    access-log:
      <<: *logger
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
        key-file: /keys/mozaic.fm/privkey.pem
        certificate-file: /keys/mozaic.fm/fullchain.pem
    listen:
      port: 443
      ssl:
        <<: *ssl
        key-file: /keys/mozaic.fm/privkey.pem
        certificate-file: /keys/mozaic.fm/fullchain.pem

    # HSTS
    header.add: "Strict-Transport-Security: max-age=31536000"

    # Reporing
    header.add: "Report-To: {\"group\":\"default\", \"include-subdomains\":true, \"max_age\":864000, \"endpoints\":{\"url\":\"https://reporting.jxck.io\"}}"

    # Expect-CT
    # header.add: "Expect-CT: max-age=31536000, report-uri https://reporting.jxck.io;"

    # Cache
    header.add: "Cache-Control: no-cache"

    # no-sniff
    header.add: "X-Content-Type-Options: nosniff"

    # frame options
    header.add: "X-Frame-Options: sameorigin"

    # Referer Policy
    header.add: "Referrer-Policy: strict-origin-when-cross-origin"

    # HTTP3
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"

    paths:
      "/.well-known":
        file.dir: ./mozaic.fm/.well-known
      "/LLMS.txt":
        file.file: ./www.jxck.io/LLMS.mozaic.fm.md
      "/favicon.ico":
        file.file: ./www.jxck.io/assets/img/mozaic.png
      "/apple-touch-icon-precomposed.png":
        file.file: ./www.jxck.io/assets/img/mozaic.png
      "/apple-touch-icon.png":
        file.file: ./www.jxck.io/assets/img/mozaic.png
      "/manifest.webmanifest":
        header.set: "Cache-Control: no-cache"
        file.file: ./mozaic.fm/manifest.webmanifest
      "/assets/js/sw.js":
        header.set: "Cache-Control: no-cache"
        header.add: "Service-Worker-Allowed: /"
        header.set: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
        file.file: ./www.jxck.io/assets/js/sw.js
      "/assets/font":
        mruby.handler-file: .mruby.handler/cors.rb # check my origin
        # header.set: "Cross-Origin-Resource-Policy: same-origin"
        header.set: "Cache-Control: max-age=2592000"
        header.add: "Cache-Control: immutable"
        file.dir: ./mozaic.fm/assets/font
      "/post":
        mruby.handler-file: .mruby.handler/mozaic.rb
      "/rss":
        redirect:
          status: 308
          url: https://feed.mozaic.fm:443/
      "/cert.cbor":
        file.file: ./labs.jxck.io/webpackaging/tmp/cert.cbor
      "/searches":
        redirect:
          status: 308
          url: /search
      "/search":
        file.file: ./mozaic.fm/search/search.cgi
      "/":
        # Remove Cookies
        # header.add: "Set-Cookie: _ga=empty; path=/; max-age=0; domain=mozaic.fm"
        # header.add: "Clear-Site-Data: \"cookies\""

        # Cache
        header.add: "Cache-Control: no-cache"

        # HTTP3
        header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"

        # CSP
        header.add: "Content-Security-Policy: script-src 'self'; require-trusted-types-for 'script'; trusted-types html-policy script-policy template-policy 'allow-duplicates'; report-to default"

        # Network Error Logging (no success, all error)
        header.add: "NEL: {\"report-to\":\"default\", \"max-age\":864000, \"include-subdomains\":true, \"success-fraction\":0, \"error-fraction\":1.0}"

        # Cross-Origin-*
        # header.add: "Cross-Origin-Resource-Policy: same-origin"
        # header.add: "Cross-Origin-Opener-Policy: same-origin"
        # header.add: "Cross-Origin-Embedder-Policy: require-corp"

        # Service Worker
        header.add: "Service-Worker-Allowed: /"

        # Origin Trial: Content Indexing
        header.add: "Origin-Trial: AtLp0RGsnhc2lQCG49/jCExmjHA7j+geTUcYrYqQMruWWoUPbVFPHXuEjQ8zPv2npRaBLfqqxBGVfkRHtsfhmQMAAABieyJvcmlnaW4iOiJodHRwczovL21vemFpYy5mbTo0NDMiLCJmZWF0dXJlIjoiQ29udGVudEluZGV4IiwiZXhwaXJ5IjoxNTkxMTYwNjIyLCJpc1N1YmRvbWFpbiI6dHJ1ZX0="

        mruby.handler-file: .mruby.handler/robots.rb
        file.dir: ./mozaic.fm

  "files.mozaic.fm:80":
    listen:
      port: 80
    paths:
      "/.well-known":
        file.dir: ./mozaic.fm/.well-known
      "/":
        mruby.handler-file: .mruby.handler/hsts.rb
  "files.mozaic.fm":
    access-log:
      <<: *logger
    listen:
      port: 443
      type: quic
      ssl:
        <<: *ssl
        key-file: /keys/mozaic.fm/privkey.pem
        certificate-file: /keys/mozaic.fm/fullchain.pem
    listen:
      port: 443
      ssl:
        <<: *ssl
        key-file: /keys/mozaic.fm/privkey.pem
        certificate-file: /keys/mozaic.fm/fullchain.pem
    header.add: "Cache-Control: no-cache"
    header.add: "X-Content-Type-Options: nosniff"
    header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      "/.well-known":
        file.dir: ./mozaic.fm/.well-known
      "/mozaic.png":
        file.file: ./www.jxck.io/assets/img/mozaic.png
      "/mozaic.jpeg":
        file.file: ./www.jxck.io/assets/img/mozaic.jpeg
      "/mozaic.webp":
        file.file: ./www.jxck.io/assets/img/mozaic.webp
      "/mozaic.svg":
        file.file: ./www.jxck.io/assets/img/mozaic.svg
      "/":
        header.add: "Access-Control-Allow-Origin: https://mozaic.fm"
        header.add: "Access-Control-Allow-Methods: GET, HEAD, OPTIONS"
        header.add: "Access-Control-Allow-Credentials: true"
        header.add: "Access-Control-Expose-Headers: *"
        # header.add: "Cross-Origin-Resource-Policy: cross-origin"
        mruby.handler-file: .mruby.handler/mozaic-file.rb
        mruby.handler-file: .mruby.handler/robots.rb
        file.dir: ./files.mozaic.fm

  "feed.mozaic.fm:80":
    listen:
      port: 80
    paths: &feed
      # README: Apple podcast は 308 に対応してない
      "/.well-known":
        file.dir: ./mozaic.fm/.well-known
      "/index.json":
        header.set: "Content-Type: application/json; charset=utf-8"
        header.add: "Access-Control-Allow-Methods: GET, HEAD, OPTIONS"
        header.add: "Access-Control-Allow-Origin: https://mozaic.fm"
        header.add: "Access-Control-Expose-Headers: *"
        file.file: ./feed.mozaic.fm/index.json
      "/":
        header.set: "Content-Type: application/rss+xml; charset=utf-8"
        header.add: "Access-Control-Allow-Methods: GET, HEAD, OPTIONS"
        header.add: "Access-Control-Allow-Origin: *"
        header.add: "Access-Control-Expose-Headers: *"
        file.file: ./feed.mozaic.fm/index.xml
  "feed.mozaic.fm":
    access-log:
      <<: *logger
    # listen:
    #   port: 443
    #   type: quic
    #   ssl:
    #     <<: *ssl
    #     key-file: /keys/mozaic.fm/privkey.pem
    #     certificate-file: /keys/mozaic.fm/fullchain.pem
    listen:
      port: 443
      ssl:
        <<: *ssl
        key-file: /keys/mozaic.fm/privkey.pem
        certificate-file: /keys/mozaic.fm/fullchain.pem
    header.add: "Cache-Control: no-cache"
    header.add: "X-Content-Type-Options: nosniff"
    # header.add: "Alt-Svc: h3=\":443\";ma=60,quic=\":443\";ma=60"
    paths:
      <<: *feed

  "labs.mozaic.fm":
    access-log:
      path: ./labs.jxck.io/access.log
      format: "%{%Y/%m/%d %H:%M:%S}t.%{msec_frac}t\t%h\t%H\t%s\t%m\t%V\t%U%q\t\"%{User-agent}i\"\t\"%{Referer}i\"\t%{response-time}x\t%{HEADERS}e"
    listen:
      port: 443
      ssl:
        <<: *ssl
        key-file: /keys/mozaic.fm/privkey.pem
        certificate-file: /keys/mozaic.fm/fullchain.pem
    listen:
      port: 80
    paths:
      <<: *labs-path
      "/.well-known":
        file.dir: ./mozaic.fm/.well-known
